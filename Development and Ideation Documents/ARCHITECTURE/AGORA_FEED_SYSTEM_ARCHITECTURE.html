<!DOCTYPE html>
<html>
<head>
<title>AGORA_FEED_SYSTEM_ARCHITECTURE.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">
<link rel="stylesheet" href="print-styles.css" media="print">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="agora-feed-system-architecture">Agora Feed System Architecture</h1>
<h2 id="comprehensive-real-time-event-feed--deliberation-integration">Comprehensive Real-Time Event Feed &amp; Deliberation Integration</h2>
<p><strong>Version:</strong> 1.0<br>
<strong>Last Updated:</strong> January 2025<br>
<strong>Document Type:</strong> System Architecture Specification</p>
<hr>
<h2 id="table-of-contents">Table of Contents</h2>
<ol>
<li><a href="#1-executive-summary">Executive Summary</a></li>
<li><a href="#2-system-overview">System Overview</a></li>
<li><a href="#3-architecture-diagrams">Architecture Diagrams</a></li>
<li><a href="#4-data-models">Data Models</a></li>
<li><a href="#5-component-architecture">Component Architecture</a></li>
<li><a href="#6-real-time-event-infrastructure">Real-Time Event Infrastructure</a></li>
<li><a href="#7-api-specifications">API Specifications</a></li>
<li><a href="#8-plexus-visualization-system">Plexus Visualization System</a></li>
<li><a href="#9-following--subscription-system">Following &amp; Subscription System</a></li>
<li><a href="#10-deliberation-integration">Deliberation Integration</a></li>
<li><a href="#11-performance--scalability">Performance &amp; Scalability</a></li>
<li><a href="#12-appendices">Appendices</a></li>
</ol>
<hr>
<h2 id="1-executive-summary">1. Executive Summary</h2>
<h3 id="11-purpose">1.1 Purpose</h3>
<p>The <strong>Agora Feed System</strong> serves as the central real-time activity hub for the Mesh platform. It provides users with a unified view of all collaborative activities across deliberations, citations, stacks, and discussions. The system integrates deeply with the deliberation infrastructure, enabling users to discover, follow, and participate in structured reasoning processes.</p>
<h3 id="12-key-capabilities">1.2 Key Capabilities</h3>
<table>
<thead>
<tr>
<th>Capability</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Real-Time Event Feed</strong></td>
<td>Server-Sent Events (SSE) infrastructure delivering instant updates</td>
</tr>
<tr>
<td><strong>Event Coalescing</strong></td>
<td>Intelligent bundling of similar events to reduce noise</td>
</tr>
<tr>
<td><strong>Multi-View Interface</strong></td>
<td>Feed, Debates, and Plexus visualization modes</td>
</tr>
<tr>
<td><strong>Following System</strong></td>
<td>Room, tag, and stack subscription management</td>
</tr>
<tr>
<td><strong>Cross-Room Navigation</strong></td>
<td>Plexus network visualization showing room relationships</td>
</tr>
<tr>
<td><strong>Debate Sheet Integration</strong></td>
<td>Direct access to structured argument views</td>
</tr>
</tbody>
</table>
<h3 id="13-system-boundaries">1.3 System Boundaries</h3>
<pre class="hljs"><code><div>┌─────────────────────────────────────────────────────────────────────┐
│                      AGORA FEED SYSTEM                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────────────────┐   │
│  │ Feed View   │   │ Debates View│   │ Plexus View             │   │
│  │             │   │             │   │ (Board/Graph/Matrix)    │   │
│  └──────┬──────┘   └──────┬──────┘   └───────────┬─────────────┘   │
│         │                 │                       │                 │
│         └─────────────────┴───────────────────────┘                 │
│                           │                                         │
│              ┌────────────┴────────────┐                           │
│              │    Event Processing     │                           │
│              │    (Coalescing, SWR)    │                           │
│              └────────────┬────────────┘                           │
│                           │                                         │
│         ┌─────────────────┴─────────────────┐                      │
│         │                                    │                      │
│    ┌────┴─────┐                     ┌───────┴───────┐              │
│    │ SSE Bus  │                     │ REST APIs     │              │
│    │ /api/events                    │ /api/agora/*  │              │
│    └──────────┘                     └───────────────┘              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        ▼                     ▼                     ▼
┌───────────────┐   ┌─────────────────┐   ┌─────────────────┐
│ Deliberations │   │ Stacks/Library  │   │ Discussions     │
│ System        │   │ System          │   │ System          │
└───────────────┘   └─────────────────┘   └─────────────────┘
</div></code></pre>
<h3 id="14-technology-stack">1.4 Technology Stack</h3>
<table>
<thead>
<tr>
<th>Layer</th>
<th>Technology</th>
</tr>
</thead>
<tbody>
<tr>
<td>Frontend</td>
<td>React 18, Next.js 14 (App Router), TypeScript</td>
</tr>
<tr>
<td>State Management</td>
<td>SWR for data fetching, React useState/useEffect</td>
</tr>
<tr>
<td>Real-Time</td>
<td>Server-Sent Events (EventSource API)</td>
</tr>
<tr>
<td>Server Bus</td>
<td>Node.js EventEmitter (singleton)</td>
</tr>
<tr>
<td>Database</td>
<td>PostgreSQL via Prisma ORM</td>
</tr>
<tr>
<td>Styling</td>
<td>Tailwind CSS, clsx</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="2-system-overview">2. System Overview</h2>
<h3 id="21-core-concepts">2.1 Core Concepts</h3>
<h4 id="211-agoraevent">2.1.1 AgoraEvent</h4>
<p>The fundamental unit of the feed system. Each event represents an activity that occurred in the platform.</p>
<pre class="hljs"><code><div><span class="hljs-keyword">type</span> AgoraEvent = {
  id: <span class="hljs-built_in">string</span>;              <span class="hljs-comment">// Unique identifier for deduplication</span>
  <span class="hljs-keyword">type</span>: BusEvent;          <span class="hljs-comment">// Event category (dialogue:changed, citations:changed, etc.)</span>
  ts: <span class="hljs-built_in">number</span>;              <span class="hljs-comment">// Timestamp in epoch milliseconds</span>
  title: <span class="hljs-built_in">string</span>;           <span class="hljs-comment">// Human-readable event title</span>
  meta?: <span class="hljs-built_in">string</span>;           <span class="hljs-comment">// Additional context (room ID, target info)</span>
  chips?: <span class="hljs-built_in">string</span>[];        <span class="hljs-comment">// Tags/labels for filtering</span>
  link?: <span class="hljs-built_in">string</span>;           <span class="hljs-comment">// Primary navigation link</span>
  deliberationId?: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// Associated deliberation (if any)</span>
  targetType?: <span class="hljs-built_in">string</span>;     <span class="hljs-comment">// Target entity type (claim, comment, etc.)</span>
  targetId?: <span class="hljs-built_in">string</span>;       <span class="hljs-comment">// Target entity ID</span>
  icon?: <span class="hljs-built_in">string</span>;           <span class="hljs-comment">// Visual indicator (move, link, check, vote, branch)</span>
};
</div></code></pre>
<h4 id="212-event-types">2.1.2 Event Types</h4>
<p>Events are categorized by their source system:</p>
<table>
<thead>
<tr>
<th>Category</th>
<th>Event Types</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Dialogue</strong></td>
<td><code>dialogue:moves:refresh</code>, <code>dialogue:changed</code>, <code>dialogue:cs:refresh</code></td>
<td>Argument moves, state changes</td>
</tr>
<tr>
<td><strong>Claims</strong></td>
<td><code>claims:edges:changed</code>, <code>cqs:changed</code></td>
<td>Claim relationships, critical questions</td>
</tr>
<tr>
<td><strong>Decisions</strong></td>
<td><code>decision:changed</code>, <code>votes:changed</code></td>
<td>Voting, acceptance/rejection</td>
</tr>
<tr>
<td><strong>Content</strong></td>
<td><code>stacks:changed</code>, <code>comments:changed</code>, <code>citations:changed</code></td>
<td>User content updates</td>
</tr>
<tr>
<td><strong>Structure</strong></td>
<td><code>deliberations:created</code>, <code>xref:changed</code></td>
<td>New deliberations, cross-references</td>
</tr>
</tbody>
</table>
<h4 id="213-view-modes">2.1.3 View Modes</h4>
<p>The Agora interface offers three distinct view modes:</p>
<table>
<thead>
<tr>
<th>Mode</th>
<th>Purpose</th>
<th>Key Components</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Feed</strong></td>
<td>Real-time activity stream</td>
<td>EventCard, FiltersPanel, RightRail</td>
</tr>
<tr>
<td><strong>Debates</strong></td>
<td>Structured argument navigation</td>
<td>RoomPicker, DebatePicker, DebateSheetReader</td>
</tr>
<tr>
<td><strong>Plexus</strong></td>
<td>Room relationship visualization</td>
<td>PlexusBoard, Plexus (Graph), PlexusMatrix</td>
</tr>
</tbody>
</table>
<h3 id="22-data-flow-overview">2.2 Data Flow Overview</h3>
<pre class="hljs"><code><div>┌──────────────────────────────────────────────────────────────────────────┐
│                          EVENT LIFECYCLE                                  │
└──────────────────────────────────────────────────────────────────────────┘

1. EVENT EMISSION (Server-Side)
   ┌─────────────┐      emitBus()      ┌─────────────┐
   │ API Route   │ ──────────────────► │ Event Bus   │
   │ (mutation)  │                     │ (singleton) │
   └─────────────┘                     └──────┬──────┘
                                              │
2. EVENT BROADCAST                            │
                                              ▼
   ┌─────────────────────────────────────────────────────────────────┐
   │                    SSE ENDPOINT (/api/events)                   │
   │  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐           │
   │  │ Client A    │   │ Client B    │   │ Client C    │           │
   │  │ EventSource │   │ EventSource │   │ EventSource │           │
   │  └─────────────┘   └─────────────┘   └─────────────┘           │
   └─────────────────────────────────────────────────────────────────┘
                                              │
3. CLIENT PROCESSING                          ▼
   ┌─────────────────────────────────────────────────────────────────┐
   │                   LiveEventsProvider                            │
   │  ┌───────────────┐   ┌───────────────┐   ┌───────────────┐     │
   │  │ Coalesce      │   │ SWR Mutate    │   │ Window Event  │     │
   │  │ (bundle)      │   │ (revalidate)  │   │ (legacy)      │     │
   │  └───────────────┘   └───────────────┘   └───────────────┘     │
   └─────────────────────────────────────────────────────────────────┘
                                              │
4. UI UPDATE                                  ▼
   ┌─────────────────────────────────────────────────────────────────┐
   │                      Agora Component                            │
   │  ┌───────────────┐   ┌───────────────┐   ┌───────────────┐     │
   │  │ Filter Events │   │ Render Cards  │   │ Update State  │     │
   │  │ (tab/search)  │   │ (EventCard)   │   │ (selection)   │     │
   │  └───────────────┘   └───────────────┘   └───────────────┘     │
   └─────────────────────────────────────────────────────────────────┘
</div></code></pre>
<h3 id="23-integration-points">2.3 Integration Points</h3>
<p>The Agora system integrates with multiple platform subsystems:</p>
<pre class="hljs"><code><div>                    ┌─────────────────┐
                    │  AGORA SYSTEM   │
                    └────────┬────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
        ▼                    ▼                    ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│ Deliberations │   │   Stacks &amp;    │   │  Discussions  │
│               │   │   Libraries   │   │               │
│ • Arguments   │   │ • PDFs        │   │ • Forums      │
│ • Claims      │   │ • Subscriptions│  │ • Comments    │
│ • Schemes     │   │ • Citations   │   │ • Threads     │
│ • Decisions   │   └───────────────┘   └───────────────┘
│ • Votes       │
└───────────────┘
        │
        ▼
┌───────────────┐
│  Thesis &amp;     │
│  Knowledge    │
│  Bases        │
└───────────────┘
</div></code></pre>
<hr>
<h2 id="3-architecture-diagrams">3. Architecture Diagrams</h2>
<h3 id="31-component-hierarchy">3.1 Component Hierarchy</h3>
<pre class="hljs"><code><div>app/agora/
├── page.tsx                    # Server Component (initial fetch)
│   └── Agora                   # Client Component (main)
│       ├── TopBar              # Navigation &amp; controls
│       │   ├── HomeButton
│       │   ├── Segmented (tabs)
│       │   └── Search/Pause controls
│       │
│       ├── [view === 'feed']
│       │   ├── FiltersPanel    # Left sidebar (placeholder)
│       │   ├── EventCard[]     # Event list
│       │   │   ├── Icon
│       │   │   ├── Title/Meta
│       │   │   ├── Chips
│       │   │   └── Actions (Open, Follow, Reply)
│       │   └── RightRail       # Context panel
│       │       ├── Room info
│       │       ├── Navigator (backlinks)
│       │       └── StackSummaryCard
│       │
│       ├── [view === 'debates']
│       │   ├── RoomPicker
│       │   ├── DebatePicker
│       │   ├── SheetPicker
│       │   └── DebateSheetReader
│       │       ├── DebateSheetHeader
│       │       ├── DebateSheetFilters
│       │       ├── ArgumentNetworkCard[]
│       │       └── SupportBar
│       │
│       └── [view === 'plexus']
│           └── PlexusShell
│               ├── ViewModeSelector
│               ├── PlexusBoard     # Card grid
│               ├── Plexus          # Force-directed graph
│               └── PlexusMatrix    # Adjacency matrix

app/agora/
└── LiveEventsProvider.tsx      # Wraps app layout (SSE consumer)

lib/client/
├── useFollowing.ts             # Room/tag follow state
├── useStackFollowing.ts        # Stack subscription state
└── useBusEffect.ts             # SSE subscription hook

lib/server/
├── bus.ts                      # Event bus singleton
lib/events/
└── topics.ts                   # BusEvent type definitions
</div></code></pre>
<h3 id="32-server-side-architecture">3.2 Server-Side Architecture</h3>
<pre class="hljs"><code><div>┌─────────────────────────────────────────────────────────────────────────┐
│                         SERVER INFRASTRUCTURE                           │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                          Event Bus (Singleton)                          │
│                         lib/server/bus.ts                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  globalThis.__meshBus__ = new EventEmitter()                    │   │
│  │  maxListeners: 50                                               │   │
│  │                                                                 │   │
│  │  Methods:                                                       │   │
│  │  • emitBus(type, payload) → BusEnvelope                        │   │
│  │  • onBus(type, handler)   → void                               │   │
│  │  • offBus(type, handler)  → void                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────┬────────────────────────────────────┘
                                     │
            ┌────────────────────────┼────────────────────────┐
            │                        │                        │
            ▼                        ▼                        ▼
┌───────────────────┐   ┌───────────────────┐   ┌───────────────────┐
│ SSE Endpoint      │   │ API Mutations     │   │ Workers/Cron      │
│ /api/events       │   │ /api/dialogue/*   │   │ workers/          │
│                   │   │ /api/claims/*     │   │                   │
│ Subscribes to all │   │ Call emitBus()    │   │ Emit background   │
│ BUS_EVENTS        │   │ after mutations   │   │ events            │
└───────────────────┘   └───────────────────┘   └───────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                          Ring Buffer (In-Memory)                        │
│                         app/api/events/route.ts                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  globalThis.__agoraRing__ = { buf: [], cap: 2048 }              │   │
│  │  globalThis.__agoraSeq__ = 0  // Sequential event IDs           │   │
│  │                                                                 │   │
│  │  Features:                                                      │   │
│  │  • Circular buffer (FIFO, 2048 events)                         │   │
│  │  • Sequential IDs for resumability                             │   │
│  │  • last-event-id header support                                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
</div></code></pre>
<h3 id="33-client-side-event-flow">3.3 Client-Side Event Flow</h3>
<pre class="hljs"><code><div>┌─────────────────────────────────────────────────────────────────────────┐
│                       CLIENT EVENT PROCESSING                           │
└─────────────────────────────────────────────────────────────────────────┘

                         Browser Tab
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        app/(app)/layout.tsx                             │
│  &lt;LiveEventsProvider&gt;                                                   │
│      {children}                                                         │
│  &lt;/LiveEventsProvider&gt;                                                  │
└────────────────────────────────────┬────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       LiveEventsProvider                                │
│                   app/agora/LiveEventsProvider.tsx                      │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  EventSource(&quot;/api/events?lastEventId=...&quot;)                     │   │
│  │                                                                 │   │
│  │  1. Subscribe to ALL named topics (TOPICS array)                │   │
│  │  2. Parse incoming JSON payloads                                │   │
│  │  3. Normalize envelope format                                   │   │
│  └──────────────────────────────┬──────────────────────────────────┘   │
│                                 │                                       │
│                                 ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  handle(raw) callback                                           │   │
│  │                                                                 │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │   │
│  │  │ Coalesce    │  │ SWR Mutate  │  │ Window CustomEvent      │ │   │
│  │  │ to buffer   │  │ via KEYMAP  │  │ (legacy bridge)         │ │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  useSafetyBackfill() - Periodic safety net                      │   │
│  │  • Poll /api/agora/events?since=... every 60s                   │   │
│  │  • Trigger on visibilitychange (tab focus)                      │   │
│  │  • Trigger on 'online' event (network reconnect)                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         Agora Component                                 │
│                      app/agora/ui/Agora.tsx                             │
│                                                                         │
│  useBusEffect(&quot;*&quot;, handler)                                             │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  Event Handler:                                                 │   │
│  │  1. Parse message to AgoraEvent                                 │   │
│  │  2. coalesce(prev, ev) → bundle similar events                  │   │
│  │  3. setEvents(coalescedList.slice(0, 200))                      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  State: [events, setEvents] ─────────► Render EventCard list           │
└─────────────────────────────────────────────────────────────────────────┘
</div></code></pre>
<h3 id="34-event-coalescing-algorithm">3.4 Event Coalescing Algorithm</h3>
<pre class="hljs"><code><div>┌─────────────────────────────────────────────────────────────────────────┐
│                      EVENT COALESCING LOGIC                             │
└─────────────────────────────────────────────────────────────────────────┘

Input: Previous events array, New event

┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│  BUNDLE_WINDOW_MS = 3 * 60 * 1000  (3 minutes)                         │
│  CITATION_BUNDLE_WINDOW_MS = 2 * 60 * 1000  (2 minutes)                │
│  FEED_CAP = 300 events                                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

                    New Event Arrives
                          │
                          ▼
              ┌───────────────────────┐
              │ Is citations:changed? │
              └───────────┬───────────┘
                    │           │
                   YES          NO
                    │           │
                    ▼           ▼
        ┌───────────────┐  ┌───────────────────────┐
        │ Find matching │  │ Is dialogue:changed   │
        │ bundle with   │  │ with deliberationId?  │
        │ same target   │  └───────────┬───────────┘
        │ within 2 min  │        │           │
        └───────┬───────┘       YES          NO
                │               │            │
    ┌───────────┴───────────┐   ▼            ▼
    │ Bundle  │ No Bundle   │   ...          │
    │ Found   │ Found       │   (same logic) │
    └────┬────┴─────┬───────┘                │
         │          │                        │
         ▼          ▼                        │
   ┌───────────┐  ┌───────────┐              │
   │ Update    │  │ Create    │              │
   │ existing  │  │ new event │◄─────────────┘
   │ bundle    │  │ (no bundle│
   │ count++   │  │ needed)   │
   └───────────┘  └───────────┘
         │              │
         └──────┬───────┘
                ▼
        ┌───────────────┐
        │ Move to front │
        │ of array      │
        └───────┬───────┘
                │
                ▼
        ┌───────────────┐
        │ Slice to      │
        │ FEED_CAP      │
        └───────────────┘
</div></code></pre>
<hr>
<h2 id="4-data-models">4. Data Models</h2>
<h3 id="41-core-prisma-models">4.1 Core Prisma Models</h3>
<h4 id="411-agoraroom">4.1.1 AgoraRoom</h4>
<p>Represents a topic-based container for deliberations.</p>
<pre class="hljs"><code><div>model AgoraRoom {
  id            String          @id @default(cuid())
  slug          String          @unique
  title         String
  summary       String?
  visibility    String          @default(&quot;public&quot;)  // &quot;public&quot; | &quot;private&quot; | &quot;unlisted&quot;
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  // Relations
  sheets        DebateSheet[]   @relation(name: &quot;RoomSheets&quot;)
  deliberations Deliberation[]
}
</div></code></pre>
<p><strong>Usage Context:</strong></p>
<ul>
<li>Rooms group related deliberations</li>
<li>Plexus visualizes room-to-room relationships</li>
<li>Users can follow rooms to receive updates</li>
</ul>
<h4 id="412-agorafollow">4.1.2 AgoraFollow</h4>
<p>Tracks user subscriptions to rooms and tags.</p>
<pre class="hljs"><code><div>model AgoraFollow {
  userId        String
  kind          String          // &quot;room&quot; | &quot;tag&quot;
  targetId      String          // Room ID or tag string
  createdAt     DateTime        @default(now())

  @@id([userId, kind, targetId])
  @@index([kind, targetId])
}
</div></code></pre>
<p><strong>Usage Context:</strong></p>
<ul>
<li>&quot;Following&quot; tab filters events to subscribed rooms</li>
<li>Tag following enables topic-based filtering</li>
<li>Drives personalized feed experience</li>
</ul>
<h4 id="413-agoraoutbox">4.1.3 AgoraOutbox</h4>
<p>Event persistence for durability and replay.</p>
<pre class="hljs"><code><div>model AgoraOutbox {
  id              String    @id @default(cuid())
  ts              DateTime  @default(now())
  topic           String    // BusEvent type
  roomId          String?
  deliberationId  String?
  targetType      String?
  targetId        String?
  payload         Json?
  delivered       Boolean   @default(false)

  @@index([ts])
  @@index([topic, deliberationId])
}
</div></code></pre>
<p><strong>Usage Context:</strong></p>
<ul>
<li>Future: Persistent event storage for durability</li>
<li>Enables event replay after server restart</li>
<li>Supports audit logging</li>
</ul>
<h4 id="414-roomfunctor">4.1.4 RoomFunctor</h4>
<p>Cross-room claim mappings for inter-deliberation relationships.</p>
<pre class="hljs"><code><div>model RoomFunctor {
  id            String    @id @default(cuid())
  fromRoomId    String    // Source deliberation
  toRoomId      String    // Target deliberation
  claimMapJson  Json      // { &quot;claimA&quot;: &quot;claimB&quot;, ... }
  notes         String?
  createdById   String?
  createdAt     DateTime  @default(now())

  @@unique([fromRoomId, toRoomId])
  @@index([fromRoomId, toRoomId])
}
</div></code></pre>
<p><strong>Usage Context:</strong></p>
<ul>
<li>Plexus &quot;imports&quot; edge type</li>
<li>Enables cross-room argument reuse</li>
<li>Category-theoretic claim transport</li>
</ul>
<h3 id="42-typescript-type-definitions">4.2 TypeScript Type Definitions</h3>
<h4 id="421-busevent-types">4.2.1 BusEvent Types</h4>
<pre class="hljs"><code><div><span class="hljs-comment">// lib/events/topics.ts</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> BUS_EVENTS = [
  <span class="hljs-string">'dialogue:moves:refresh'</span>,
  <span class="hljs-string">'dialogue:cs:refresh'</span>,
  <span class="hljs-string">'claims:edges:changed'</span>,
  <span class="hljs-string">'cqs:changed'</span>,
  <span class="hljs-string">'cards:changed'</span>,
  <span class="hljs-string">'decision:changed'</span>,
  <span class="hljs-string">'votes:changed'</span>,
  <span class="hljs-string">'stacks:changed'</span>,
  <span class="hljs-string">'deliberations:created'</span>,
  <span class="hljs-string">'comments:changed'</span>,
  <span class="hljs-string">'xref:changed'</span>,
  <span class="hljs-string">'citations:changed'</span>,
  <span class="hljs-string">'dialogue:changed'</span>,
  <span class="hljs-string">'issues:changed'</span>,
] <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> BusEvent = <span class="hljs-keyword">typeof</span> BUS_EVENTS[<span class="hljs-built_in">number</span>];
</div></code></pre>
<h4 id="422-bus-payload-types">4.2.2 Bus Payload Types</h4>
<pre class="hljs"><code><div><span class="hljs-comment">// lib/server/bus.ts</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> BusPayloadMap {
  <span class="hljs-string">'dialogue:moves:refresh'</span>: {
    deliberationId: <span class="hljs-built_in">string</span>;
    moveId?: <span class="hljs-built_in">string</span>;
    kind?: <span class="hljs-built_in">string</span>;
  };
  <span class="hljs-string">'dialogue:cs:refresh'</span>: {
    deliberationId: <span class="hljs-built_in">string</span>;
    participantId?: <span class="hljs-built_in">string</span>;
  };
  <span class="hljs-string">'dialogue:changed'</span>: {
    deliberationId: <span class="hljs-built_in">string</span>;
    moveId?: <span class="hljs-built_in">string</span>;
    kind?: <span class="hljs-built_in">string</span>;
    chips?: <span class="hljs-built_in">string</span>[];
  };
  <span class="hljs-string">'citations:changed'</span>: {
    targetType: <span class="hljs-built_in">string</span>;      <span class="hljs-comment">// "claim" | "comment"</span>
    targetId: <span class="hljs-built_in">string</span>;
    sourceId?: <span class="hljs-built_in">string</span>;
    url?: <span class="hljs-built_in">string</span>;
    quote?: <span class="hljs-built_in">string</span>;
    note?: <span class="hljs-built_in">string</span>;
    deliberationId?: <span class="hljs-built_in">string</span>;
  };
  <span class="hljs-string">'deliberations:created'</span>: {
    id: <span class="hljs-built_in">string</span>;
    hostType: <span class="hljs-built_in">string</span>;
    hostId: <span class="hljs-built_in">string</span>;
  };
  <span class="hljs-comment">// Additional types as needed...</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> BusPayload&lt;T <span class="hljs-keyword">extends</span> BusEvent&gt; =
  T <span class="hljs-keyword">extends</span> keyof BusPayloadMap ? BusPayloadMap[T] : Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> BusEnvelope&lt;T <span class="hljs-keyword">extends</span> BusEvent = BusEvent&gt; =
  { <span class="hljs-keyword">type</span>: T; ts: <span class="hljs-built_in">number</span> } &amp; BusPayload&lt;T&gt;;
</div></code></pre>
<h4 id="423-network-graph-types">4.2.3 Network Graph Types</h4>
<pre class="hljs"><code><div><span class="hljs-comment">// Used by Plexus components</span>

<span class="hljs-keyword">type</span> EdgeKind = <span class="hljs-string">'xref'</span> | <span class="hljs-string">'overlap'</span> | <span class="hljs-string">'stack_ref'</span> | <span class="hljs-string">'imports'</span> | <span class="hljs-string">'shared_author'</span>;

<span class="hljs-keyword">type</span> RoomNode = {
  id: <span class="hljs-built_in">string</span>;
  title?: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>;
  nArgs: <span class="hljs-built_in">number</span>;           <span class="hljs-comment">// Argument count</span>
  nEdges: <span class="hljs-built_in">number</span>;          <span class="hljs-comment">// Edge count</span>
  accepted: <span class="hljs-built_in">number</span>;        <span class="hljs-comment">// Accepted claims</span>
  rejected: <span class="hljs-built_in">number</span>;        <span class="hljs-comment">// Rejected claims</span>
  undecided: <span class="hljs-built_in">number</span>;       <span class="hljs-comment">// Undecided claims</span>
  tags?: <span class="hljs-built_in">string</span>[];
  updatedAt?: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>;
  debateSheetId?: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>;
};

<span class="hljs-keyword">type</span> MetaEdge = {
  <span class="hljs-keyword">from</span>: <span class="hljs-built_in">string</span>;            <span class="hljs-comment">// Source room ID</span>
  to: <span class="hljs-built_in">string</span>;              <span class="hljs-comment">// Target room ID</span>
  kind: EdgeKind;
  weight: <span class="hljs-built_in">number</span>;          <span class="hljs-comment">// Connection strength</span>
};

<span class="hljs-keyword">type</span> Network = {
  scope: <span class="hljs-string">'public'</span> | <span class="hljs-string">'following'</span>;
  version: <span class="hljs-built_in">number</span>;
  rooms: RoomNode[];
  edges: MetaEdge[];
};
</div></code></pre>
<h3 id="43-entity-relationship-diagram">4.3 Entity Relationship Diagram</h3>
<pre class="hljs"><code><div>┌─────────────────────────────────────────────────────────────────────────┐
│                        AGORA DATA MODEL                                 │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│  AgoraRoom  │─────────│ Deliberation │─────────│   Argument  │
│             │   1:N   │             │   1:N   │             │
│ id          │         │ id          │         │ id          │
│ slug        │         │ title       │         │ text        │
│ title       │         │ hostType    │         │ kind        │
│ summary     │         │ hostId      │         │             │
│ visibility  │         │ agoraRoomId │◄────────│deliberationId│
└──────┬──────┘         └──────┬──────┘         └─────────────┘
       │                       │
       │                       │
       │                ┌──────┴──────┐
       │                │             │
       ▼                ▼             ▼
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│ DebateSheet │  │ DialogueMove │  │    Claim    │
│             │  │             │  │             │
│ id          │  │ id          │  │ id          │
│ title       │  │ kind        │  │ text        │
│ deliberation│  │ targetType  │  │ confidence  │
│ agoraRoomId │  │ targetId    │  │ deliberation│
└─────────────┘  └─────────────┘  └─────────────┘

┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│ AgoraFollow │         │ AgoraOutbox │         │ RoomFunctor │
│             │         │             │         │             │
│ userId      │         │ id          │         │ id          │
│ kind        │         │ ts          │         │ fromRoomId  │
│ targetId    │         │ topic       │         │ toRoomId    │
│ createdAt   │         │ payload     │         │ claimMapJson│
│             │         │ delivered   │         │ notes       │
└─────────────┘         └─────────────┘         └─────────────┘

Legend:
─────── : Foreign key relationship
1:N     : One-to-many cardinality
◄────── : Reference direction
</div></code></pre>
<hr>
<h2 id="5-component-architecture">5. Component Architecture</h2>
<h3 id="51-agora-main-component">5.1 Agora Main Component</h3>
<p><strong>File:</strong> <code>app/agora/ui/Agora.tsx</code> (832 lines)</p>
<p>The central component orchestrating the entire Agora interface.</p>
<h4 id="511-component-props">5.1.1 Component Props</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Agora</span>(<span class="hljs-params">{
  initialEvents,
}: {
  initialEvents: AgoraEvent[];
}</span>) </span>{
  <span class="hljs-comment">// Server-rendered initial events for instant display</span>
}
</div></code></pre>
<h4 id="512-state-management">5.1.2 State Management</h4>
<pre class="hljs"><code><div><span class="hljs-comment">// Core state</span>
<span class="hljs-keyword">const</span> [events, setEvents] = useState&lt;AgoraEvent[]&gt;(initialEvents);
<span class="hljs-keyword">const</span> [paused, setPaused] = useState(<span class="hljs-literal">false</span>);
<span class="hljs-keyword">const</span> [tab, setTab] = useState&lt;<span class="hljs-string">"all"</span> | <span class="hljs-string">"following"</span> | <span class="hljs-string">"calls"</span> | <span class="hljs-string">"votes"</span> | <span class="hljs-string">"accepted"</span>&gt;(<span class="hljs-string">"all"</span>);
<span class="hljs-keyword">const</span> [view, setView] = useState&lt;<span class="hljs-string">"feed"</span> | <span class="hljs-string">"debates"</span> | <span class="hljs-string">"plexus"</span>&gt;(<span class="hljs-string">"feed"</span>);
<span class="hljs-keyword">const</span> [q, setQ] = useState(<span class="hljs-string">""</span>);
<span class="hljs-keyword">const</span> [selected, setSelected] = useState&lt;AgoraEvent | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

<span class="hljs-comment">// Following state (from hooks)</span>
<span class="hljs-keyword">const</span> { roomSet, isFollowingRoom, isFollowingTag, followRoom, unfollowRoom } = useFollowing();
<span class="hljs-keyword">const</span> { stackSet, isFollowingStack } = useStackFollowing();

<span class="hljs-comment">// UI state</span>
<span class="hljs-keyword">const</span> [pending, setPending] = useState&lt;Set&lt;<span class="hljs-built_in">string</span>&gt;&gt;(<span class="hljs-keyword">new</span> Set());
<span class="hljs-keyword">const</span> [ok, setOk] = useState&lt;Set&lt;<span class="hljs-built_in">string</span>&gt;&gt;(<span class="hljs-keyword">new</span> Set());

<span class="hljs-comment">// Debate view state</span>
<span class="hljs-keyword">const</span> [roomId, setRoomId] = useState&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
<span class="hljs-keyword">const</span> [debateId, setDebateId] = useState&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
<span class="hljs-keyword">const</span> [sheetKey, setSheetKey] = useState&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

<span class="hljs-comment">// Persistence</span>
<span class="hljs-keyword">const</span> [currentRoomId, setCurrentRoomId] = useState&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
<span class="hljs-keyword">const</span> [currentSheetKey, setCurrentSheetKey] = useState&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
</div></code></pre>
<h4 id="513-event-handling">5.1.3 Event Handling</h4>
<pre class="hljs"><code><div><span class="hljs-comment">// Live event subscription</span>
useBusEffect(<span class="hljs-string">"*"</span>, <span class="hljs-function">(<span class="hljs-params">m</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (paused) <span class="hljs-keyword">return</span>;
  
  <span class="hljs-keyword">const</span> t = <span class="hljs-built_in">String</span>(m?.type ?? <span class="hljs-string">""</span>);
  <span class="hljs-keyword">const</span> ts = <span class="hljs-keyword">typeof</span> m.ts === <span class="hljs-string">"number"</span> ? m.ts : <span class="hljs-built_in">Date</span>.parse(m.ts) || <span class="hljs-built_in">Date</span>.now();
  <span class="hljs-keyword">let</span> ev: AgoraEvent | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">switch</span> (t) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"dialogue:moves:refresh"</span>:
      ev = {
        id: <span class="hljs-string">`mv:<span class="hljs-subst">${m.moveId || ts}</span>`</span>,
        <span class="hljs-keyword">type</span>: <span class="hljs-string">"dialogue:changed"</span>,
        ts,
        title: <span class="hljs-string">`New move<span class="hljs-subst">${m.kind ? <span class="hljs-string">` (<span class="hljs-subst">${m.kind}</span>)`</span> : <span class="hljs-string">""</span>}</span>`</span>,
        meta: m.deliberationId ? <span class="hljs-string">`room:<span class="hljs-subst">${m.deliberationId.slice(<span class="hljs-number">0</span>, <span class="hljs-number">6</span>)}</span>…`</span> : <span class="hljs-literal">undefined</span>,
        chips: m.kind ? [m.kind] : [],
        link: m.deliberationId ? <span class="hljs-string">`/deliberation/<span class="hljs-subst">${m.deliberationId}</span>`</span> : <span class="hljs-literal">undefined</span>,
        deliberationId: m.deliberationId,
        icon: <span class="hljs-string">"move"</span>,
      };
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"citations:changed"</span>:
      ev = buildCitationEvent(m, ts);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"decision:changed"</span>:
      ev = buildDecisionEvent(m, ts);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-comment">// ... additional cases</span>
  }

  <span class="hljs-keyword">if</span> (ev) setEvents(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> coalesce(prev, ev).slice(<span class="hljs-number">0</span>, <span class="hljs-number">200</span>));
});
</div></code></pre>
<h4 id="514-filtering-logic">5.1.4 Filtering Logic</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">const</span> filtered = useMemo(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  <span class="hljs-keyword">let</span> list = events;

  <span class="hljs-comment">// Tab-based filtering</span>
  <span class="hljs-keyword">if</span> (tab === <span class="hljs-string">"accepted"</span>) list = list.filter(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> e.type === <span class="hljs-string">"decision:changed"</span>);
  <span class="hljs-keyword">if</span> (tab === <span class="hljs-string">"votes"</span>) list = list.filter(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> e.type === <span class="hljs-string">"votes:changed"</span>);

  <span class="hljs-comment">// Following filter</span>
  <span class="hljs-keyword">if</span> (tab === <span class="hljs-string">"following"</span>) {
    <span class="hljs-keyword">if</span> (!hasFollowData) <span class="hljs-keyword">return</span> events; <span class="hljs-comment">// Don't blank feed if no data yet</span>
    
    list = list.filter(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> inRooms = e.deliberationId ? roomSet.has(e.deliberationId) : <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">const</span> inTags = <span class="hljs-function">(<span class="hljs-params">e.chips || []</span>).<span class="hljs-params">some</span>(<span class="hljs-params">(<span class="hljs-params">c</span>) =&gt; isFollowingTag(<span class="hljs-params">c</span>)</span>);
      <span class="hljs-params">const</span> <span class="hljs-params">inStacks</span> = /* <span class="hljs-params">stack</span> <span class="hljs-params">following</span> <span class="hljs-params">check</span> */;
      <span class="hljs-params">const</span> <span class="hljs-params">citInRoom</span> = /* <span class="hljs-params">citation</span> <span class="hljs-params">room</span> <span class="hljs-params">check</span> */;
      <span class="hljs-params">const</span> <span class="hljs-params">citInStack</span> = /* <span class="hljs-params">citation</span> <span class="hljs-params">stack</span> <span class="hljs-params">check</span> */;
      
      <span class="hljs-params">return</span> <span class="hljs-params">inRooms</span> || <span class="hljs-params">inTags</span> || <span class="hljs-params">inStacks</span> || <span class="hljs-params">citInRoom</span> || <span class="hljs-params">citInStack</span>;
    });
  }

  // <span class="hljs-params">Search</span> <span class="hljs-params">filter</span>
  <span class="hljs-params">if</span> (<span class="hljs-params">q</span>) {
    <span class="hljs-params">const</span> <span class="hljs-params">ql</span> = <span class="hljs-params">q</span>.<span class="hljs-params">toLowerCase</span><span class="hljs-params">()</span>;
    <span class="hljs-params">list</span> = <span class="hljs-params">list</span>.<span class="hljs-params">filter</span>(<span class="hljs-params">(<span class="hljs-params">e</span>) =&gt;
      (<span class="hljs-params">e.title ?? ""</span>).toLowerCase(<span class="hljs-params"></span>).includes(<span class="hljs-params">ql</span>) ||
      (<span class="hljs-params">e.meta ?? ""</span>).toLowerCase(<span class="hljs-params"></span>).includes(<span class="hljs-params">ql</span>) ||
      (<span class="hljs-params">e.chips ?? []</span>).some(<span class="hljs-params">(<span class="hljs-params">c</span>) =&gt; c.toLowerCase(<span class="hljs-params"></span>).includes(<span class="hljs-params">ql</span>)</span>)
    </span>);
  }

  <span class="hljs-params">return</span> <span class="hljs-params">list</span>;
}, [<span class="hljs-params">events</span>, <span class="hljs-params">tab</span>, <span class="hljs-params">q</span>, <span class="hljs-params">roomSet</span>, <span class="hljs-params">isFollowingTag</span>, <span class="hljs-params">isFollowingStack</span>, <span class="hljs-params">hasFollowData</span>]);
</span></div></code></pre>
<h4 id="515-view-mode-rendering">5.1.5 View Mode Rendering</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">return</span> (
  &lt;div className=<span class="hljs-string">"mx-auto w-full max-w-screen justify-center px-0 pb-10 pt-2"</span>&gt;
    &lt;TopBar tab={tab} onTab={setTab} q={q} onQ={setQ} paused={paused} onPause={<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> setPaused(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> !p)} /&gt;
    
    {<span class="hljs-comment">/* View mode selector */</span>}
    &lt;ViewModeButtons view={view} setView={setView} /&gt;

    {<span class="hljs-comment">/* Conditional rendering based on view */</span>}
    {view === <span class="hljs-string">'plexus'</span> &amp;&amp; &lt;PlexusShell scope=<span class="hljs-string">"public"</span> /&gt;}
    
    {view === <span class="hljs-string">'debates'</span> &amp;&amp; (
      &lt;DebatesView 
        roomId={roomId} setRoomId={setRoomId}
        debateId={debateId} setDebateId={setDebateId}
        sheetKey={sheetKey} setSheetKey={setSheetKey}
      /&gt;
    )}
    
    {view === <span class="hljs-string">'feed'</span> &amp;&amp; (
      &lt;FeedView 
        filtered={filtered}
        selected={selected} setSelected={setSelected}
        isFollowingRoom={isFollowingRoom}
        followRoom={followRoom} unfollowRoom={unfollowRoom}
        pending={pending} ok={ok}
      /&gt;
    )}
  &lt;<span class="hljs-regexp">/div&gt;
);
</span></div></code></pre>
<h3 id="52-eventcard-component">5.2 EventCard Component</h3>
<p><strong>File:</strong> <code>app/agora/ui/EventCard.tsx</code> (~175 lines)</p>
<p>Renders individual events in the feed.</p>
<h4 id="521-props-interface">5.2.1 Props Interface</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EventCard</span>(<span class="hljs-params">{
  ev,
  onSelect,
  isFollowing,
  onFollow,
  onUnfollow,
  pending = <span class="hljs-literal">false</span>,
  ok = <span class="hljs-literal">false</span>,
}: {
  ev: AgoraEvent;
  onSelect?: (e: AgoraEvent) =&gt; <span class="hljs-built_in">void</span>;
  isFollowing?: <span class="hljs-built_in">boolean</span>;
  onFollow?: () =&gt; <span class="hljs-built_in">void</span>;
  onUnfollow?: () =&gt; <span class="hljs-built_in">void</span>;
  pending?: <span class="hljs-built_in">boolean</span>;
  ok?: <span class="hljs-built_in">boolean</span>;
}</span>) </span>{ ... }
</div></code></pre>
<h4 id="522-bundle-detection">5.2.2 Bundle Detection</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">const</span> isBundle = ev.type === (<span class="hljs-string">"bundle"</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>);
<span class="hljs-keyword">const</span> bundleSub = (ev <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).subtype <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>;
<span class="hljs-keyword">const</span> iconKind = isBundle 
  ? (bundleSub === <span class="hljs-string">"citations"</span> ? <span class="hljs-string">"link"</span> : <span class="hljs-string">"move"</span>) 
  : ev.icon;
</div></code></pre>
<h4 id="523-status-fetching-swr">5.2.3 Status Fetching (SWR)</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">const</span> statusUrl = (ev.type === <span class="hljs-string">"bundle"</span> <span class="hljs-keyword">as</span> AgoraEvent[<span class="hljs-string">"type"</span>]) &amp;&amp; ev.deliberationId
  ? <span class="hljs-string">`/api/dialogues/<span class="hljs-subst">${ev.deliberationId}</span>/status`</span>
  : <span class="hljs-literal">null</span>;

<span class="hljs-keyword">const</span> { data: st } = useSWR(
  statusUrl,
  <span class="hljs-function">(<span class="hljs-params">u</span>) =&gt;</span> fetch(u).then(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.ok ? r.json() : <span class="hljs-literal">null</span>),
  { revalidateOnFocus: <span class="hljs-literal">false</span>, shouldRetryOnError: <span class="hljs-literal">false</span> }
);
</div></code></pre>
<h4 id="524-chip-rendering">5.2.4 Chip Rendering</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">const</span> chips = ev.chips ?? [];
<span class="hljs-keyword">const</span> MAX_CHIPS = <span class="hljs-number">5</span>;
<span class="hljs-keyword">const</span> displayChips = chips.slice(<span class="hljs-number">0</span>, MAX_CHIPS);
<span class="hljs-keyword">const</span> extra = <span class="hljs-built_in">Math</span>.max(<span class="hljs-number">0</span>, chips.length - MAX_CHIPS);

<span class="hljs-comment">// Render chips with styling based on type</span>
{displayChips.map(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> s = <span class="hljs-built_in">String</span>(t);
  <span class="hljs-keyword">const</span> isQuote = s.startsWith(<span class="hljs-string">""</span><span class="hljs-string">");
  const isNote = s.startsWith("</span>Note:<span class="hljs-string">");
  return (
    &lt;span
      key={s}
      className={clsx(
        "</span>text-[<span class="hljs-number">11</span>px] px<span class="hljs-number">-1.5</span> py<span class="hljs-number">-0.5</span> rounded border bg-white/<span class="hljs-number">80</span><span class="hljs-string">",
        isQuote &amp;&amp; "</span>italic<span class="hljs-string">",
        isNote &amp;&amp; "</span>text-slate<span class="hljs-number">-600</span> border-slate<span class="hljs-number">-200</span><span class="hljs-string">"
      )}
      title={s}
    &gt;
      {s}
    &lt;/span&gt;
  );
})}
</span></div></code></pre>
<h4 id="525-action-buttons">5.2.5 Action Buttons</h4>
<pre class="hljs"><code><div>{<span class="hljs-comment">/* Contextual actions based on event type */</span>}
{ev.link &amp;&amp; ev.type !== <span class="hljs-string">"citations:changed"</span> &amp;&amp; (
  isExternal(ev.link) ? (
    &lt;a href={ev.link} target=<span class="hljs-string">"_blank"</span> rel=<span class="hljs-string">"noreferrer"</span> className=<span class="hljs-string">"..."</span>&gt;Open&lt;<span class="hljs-regexp">/a&gt;
  ) : (
    &lt;Link href={ev.link} className="..."&gt;Open&lt;/</span>Link&gt;
  )
)}

{ev.type === <span class="hljs-string">"dialogue:changed"</span> &amp;&amp; ev.deliberationId &amp;&amp; (
  &lt;Link href={<span class="hljs-string">`/deliberation/<span class="hljs-subst">${ev.deliberationId}</span>?mode=forum`</span>} className=<span class="hljs-string">"..."</span>&gt;
    Reply
  &lt;<span class="hljs-regexp">/Link&gt;
)}

{ev.type === "citations:changed" &amp;&amp; (ev as any).contextLink &amp;&amp; (
  &lt;Link href={(ev as any).contextLink} className="..."&gt;Context&lt;/</span>Link&gt;
)}

{<span class="hljs-comment">/* Follow/Unfollow button */</span>}
{!!ev.deliberationId &amp;&amp; (
  &lt;div className=<span class="hljs-string">"inline-flex items-center gap-2 ml-auto"</span>&gt;
    {isFollowing ? (
      &lt;button onClick={onUnfollow} disabled={pending}&gt;Following&lt;<span class="hljs-regexp">/button&gt;
    ) : (
      &lt;button onClick={onFollow} disabled={pending}&gt;Follow&lt;/</span>button&gt;
    )}
    {ok &amp;&amp; &lt;span className=<span class="hljs-string">"text-emerald-700"</span>&gt;✓ saved&lt;<span class="hljs-regexp">/span&gt;}
  &lt;/</span>div&gt;
)}
</div></code></pre>
<h3 id="53-topbar-component">5.3 TopBar Component</h3>
<p><strong>File:</strong> <code>app/agora/ui/TopBar.tsx</code> (~122 lines)</p>
<p>Navigation and controls header.</p>
<h4 id="531-tab-configuration">5.3.1 Tab Configuration</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">type</span> Tab = <span class="hljs-string">"all"</span> | <span class="hljs-string">"following"</span> | <span class="hljs-string">"calls"</span> | <span class="hljs-string">"votes"</span> | <span class="hljs-string">"accepted"</span>;

<span class="hljs-keyword">const</span> tabs: <span class="hljs-built_in">Array</span>&lt;{ value: Tab; label: <span class="hljs-built_in">string</span> }&gt; = [
  { value: <span class="hljs-string">"all"</span>,       label: <span class="hljs-string">"All"</span> },
  { value: <span class="hljs-string">"following"</span>, label: <span class="hljs-string">"Following"</span> },
  { value: <span class="hljs-string">"calls"</span>,     label: <span class="hljs-string">"Calls"</span> },
  { value: <span class="hljs-string">"votes"</span>,     label: <span class="hljs-string">"Votes"</span> },
  { value: <span class="hljs-string">"accepted"</span>,  label: <span class="hljs-string">"Accepted"</span> },
];
</div></code></pre>
<h4 id="532-segmented-control">5.3.2 Segmented Control</h4>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Segmented</span>&lt;<span class="hljs-title">T</span> <span class="hljs-title">extends</span> <span class="hljs-title">string</span>&gt;(<span class="hljs-params">{
  value,
  options,
  onChange,
  ariaLabel,
}: {
  value: T;
  options: <span class="hljs-built_in">Array</span>&lt;{ value: T; label: <span class="hljs-built_in">string</span> }&gt;;
  onChange: (v: T) =&gt; <span class="hljs-built_in">void</span>;
  ariaLabel?: <span class="hljs-built_in">string</span>;
}</span>) </span>{
  <span class="hljs-comment">// Keyboard navigation with arrow keys</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onKeyDown</span>(<span class="hljs-params">e: React.KeyboardEvent</span>) </span>{
    <span class="hljs-keyword">if</span> (e.key === <span class="hljs-string">"ArrowRight"</span>) focusBtn(idx + <span class="hljs-number">1</span>);
    <span class="hljs-keyword">if</span> (e.key === <span class="hljs-string">"ArrowLeft"</span>) focusBtn(idx - <span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">return</span> (
    &lt;nav role=<span class="hljs-string">"tablist"</span> aria-label={ariaLabel} onKeyDown={onKeyDown}&gt;
      &lt;div className=<span class="hljs-string">"inline-flex overflow-hidden rounded-xl border ..."</span>&gt;
        {options.map(<span class="hljs-function">(<span class="hljs-params">o, i</span>) =&gt;</span> (
          &lt;button
            key={o.value}
            role=<span class="hljs-string">"tab"</span>
            aria-selected={o.value === value}
            tabIndex={o.value === value ? <span class="hljs-number">0</span> : <span class="hljs-number">-1</span>}
            className={clsx(<span class="hljs-string">"px-5 py-1 ..."</span>, active &amp;&amp; <span class="hljs-string">"bg-slate-900 text-white"</span>)}
            onClick={<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> onChange(o.value)}
          &gt;
            {o.label}
          &lt;<span class="hljs-regexp">/button&gt;
        ))}
      &lt;/</span>div&gt;
    &lt;<span class="hljs-regexp">/nav&gt;
  );
}
</span></div></code></pre>
<h3 id="54-rightrail-component">5.4 RightRail Component</h3>
<p><strong>File:</strong> <code>app/agora/ui/RightRail.tsx</code> (~90 lines)</p>
<p>Context panel showing selected event details.</p>
<h4 id="541-data-extraction">5.4.1 Data Extraction</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RightRail</span>(<span class="hljs-params">{ selected }: { selected: AgoraEvent | <span class="hljs-literal">null</span> }</span>) </span>{
  <span class="hljs-comment">// Extract deliberation ID from various sources</span>
  <span class="hljs-keyword">const</span> toDelib = selected?.deliberationId || (selected <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>)?.toId || <span class="hljs-literal">null</span>;

  <span class="hljs-comment">// Extract stack ID from link or contextLink</span>
  <span class="hljs-keyword">const</span> link = (selected <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>)?.contextLink || selected?.link || <span class="hljs-string">""</span>;
  <span class="hljs-keyword">const</span> stackMatch = <span class="hljs-keyword">typeof</span> link === <span class="hljs-string">"string"</span> ? link.match(<span class="hljs-regexp">/\/stacks\/([^/?#]+)/</span>) : <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">const</span> stackIdOrSlug = stackMatch?.[<span class="hljs-number">1</span>];

  <span class="hljs-comment">// For stacks:changed events, parse from meta</span>
  <span class="hljs-keyword">const</span> stackId = selected?.type === <span class="hljs-string">"stacks:changed"</span>
    ? (selected.meta?.startsWith?.(<span class="hljs-string">"stack:"</span>) ? selected.meta.split(<span class="hljs-string">":"</span>)[<span class="hljs-number">1</span>].replace(<span class="hljs-string">"…"</span>, <span class="hljs-string">""</span>) : <span class="hljs-literal">null</span>)
    : stackIdOrSlug || <span class="hljs-literal">null</span>;
}
</div></code></pre>
<h4 id="542-backlinks-fetching">5.4.2 Backlinks Fetching</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">const</span> { data } = useSWR(
  toDelib ? <span class="hljs-string">`/api/xref?toType=deliberation&amp;toId=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(toDelib)}</span>`</span> : <span class="hljs-literal">null</span>,
  fetcher,
  { revalidateOnFocus: <span class="hljs-literal">false</span> }
);
<span class="hljs-keyword">const</span> backlinks = data?.items ?? [];
</div></code></pre>
<h4 id="543-sections">5.4.3 Sections</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">return</span> (
  &lt;div className=<span class="hljs-string">"space-y-3"</span>&gt;
    {<span class="hljs-comment">/* Room Section */</span>}
    {toDelib &amp;&amp; (
      &lt;div className=<span class="hljs-string">"rounded-xl border bg-white/70 p-3"</span>&gt;
        &lt;div className=<span class="hljs-string">"text-sm font-medium"</span>&gt;Room {toDelib}&lt;<span class="hljs-regexp">/div&gt;
        &lt;div className="mt-2 flex items-center gap-2"&gt;
          &lt;a href={`/</span>deliberation/${toDelib}<span class="hljs-string">`}&gt;Open Deliberation&lt;/a&gt;
          &lt;a href={`</span>/deliberation/${toDelib}/dialoguetimeline<span class="hljs-string">`}&gt;Open Dialogue Timeline&lt;/a&gt;
          &lt;FollowButton roomId={toDelib} /&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    )}

    {/* Navigator (XRef backlinks) */}
    &lt;div className="rounded-xl border bg-white/70 p-3"&gt;
      &lt;div className="text-sm font-medium"&gt;Navigator&lt;/div&gt;
      {!toDelib ? (
        &lt;div&gt;Select a card to see backlinks.&lt;/div&gt;
      ) : backlinks.length ? (
        &lt;ul className="mt-2 space-y-1"&gt;
          {backlinks.map((x) =&gt; (
            &lt;li key={x.id}&gt;
              {x.relation} from {x.fromType}:{x.fromId.slice(0,6)}…
              {x.fromType === 'deliberation' &amp;&amp; &lt;a href={`</span>/deliberation/${x.fromId}<span class="hljs-string">`}&gt;Open&lt;/a&gt;}
            &lt;/li&gt;
          ))}
        &lt;/ul&gt;
      ) : (
        &lt;div&gt;No backlinks.&lt;/div&gt;
      )}
    &lt;/div&gt;

    {/* Stack Summary */}
    {stackId &amp;&amp; &lt;StackSummaryCard stackId={stackId} /&gt;}
  &lt;/div&gt;
);
</span></div></code></pre>
<h3 id="55-stacksummarycard-component">5.5 StackSummaryCard Component</h3>
<p><strong>File:</strong> <code>app/agora/ui/StackSummaryCard.tsx</code> (~30 lines)</p>
<p>Displays stack metadata in the RightRail.</p>
<pre class="hljs"><code><div><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">StackSummaryCard</span>(<span class="hljs-params">{ stackId }: { stackId: <span class="hljs-built_in">string</span> }</span>) </span>{
  <span class="hljs-keyword">const</span> { data, error } = useSWR&lt;{
    id: <span class="hljs-built_in">string</span>;
    name: <span class="hljs-built_in">string</span>;
    slug: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>;
    is_public: <span class="hljs-built_in">boolean</span>;
    subscriberCount: <span class="hljs-built_in">number</span>;
  }&gt;(
    stackId ? <span class="hljs-string">`/api/stacks/<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(stackId)}</span>`</span> : <span class="hljs-literal">null</span>,
    fetcher,
    { revalidateOnFocus: <span class="hljs-literal">false</span> }
  );

  <span class="hljs-keyword">if</span> (error) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">if</span> (!data) <span class="hljs-keyword">return</span> &lt;div&gt;Loading…&lt;<span class="hljs-regexp">/div&gt;;

  const href = data.slug ? `/</span>stacks/${data.slug}<span class="hljs-string">` : `</span>/stacks/${data.id}<span class="hljs-string">`;
  
  return (
    &lt;div className="rounded-xl border bg-white/70 p-3 text-sm"&gt;
      &lt;div className="font-semibold"&gt;{data.name}&lt;/div&gt;
      &lt;div className="text-[11px] text-slate-600 mt-1"&gt;
        Visibility: {data.is_public ? 'Public' : 'Private'} · 
        Subscribers: {data.subscriberCount}
      &lt;/div&gt;
      &lt;a href={href} className="inline-block mt-2 ..."&gt;Open stack&lt;/a&gt;
    &lt;/div&gt;
  );
}
</span></div></code></pre>
<hr>
<h2 id="6-real-time-event-infrastructure">6. Real-Time Event Infrastructure</h2>
<h3 id="61-event-bus-architecture">6.1 Event Bus Architecture</h3>
<p><strong>File:</strong> <code>lib/server/bus.ts</code></p>
<p>The event bus is a Node.js EventEmitter singleton shared across all server processes.</p>
<h4 id="611-singleton-pattern">6.1.1 Singleton Pattern</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">declare</span> global {
  <span class="hljs-keyword">var</span> __meshBus__: EventEmitter | <span class="hljs-literal">undefined</span>;
}

<span class="hljs-keyword">const</span> bus: EventEmitter = globalThis.__meshBus__ ??= <span class="hljs-keyword">new</span> EventEmitter();

<span class="hljs-comment">// Increase listener limit for multiple SSE connections</span>
<span class="hljs-keyword">if</span> ((EventEmitter <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).defaultMaxListeners &lt; <span class="hljs-number">50</span>) {
  (EventEmitter <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).defaultMaxListeners = <span class="hljs-number">50</span>;
}
bus.setMaxListeners(<span class="hljs-number">50</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> bus;
</div></code></pre>
<h4 id="612-helper-functions">6.1.2 Helper Functions</h4>
<pre class="hljs"><code><div><span class="hljs-comment">/**
 * Emit an event to the bus with typed payload
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">emitBus</span>&lt;<span class="hljs-title">T</span> <span class="hljs-title">extends</span> <span class="hljs-title">BusEvent</span>&gt;(<span class="hljs-params">
  <span class="hljs-keyword">type</span>: T,
  payload: BusPayload&lt;T&gt;
</span>): <span class="hljs-title">BusEnvelope</span>&lt;<span class="hljs-title">T</span>&gt; </span>{
  <span class="hljs-keyword">const</span> env = { <span class="hljs-keyword">type</span>, ts: <span class="hljs-built_in">Date</span>.now(), ...(payload || {}) } <span class="hljs-keyword">as</span> BusEnvelope&lt;T&gt;;
  bus.emit(<span class="hljs-keyword">type</span>, env);
  <span class="hljs-keyword">return</span> env;
}

<span class="hljs-comment">/**
 * Subscribe to an event type
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onBus</span>&lt;<span class="hljs-title">T</span> <span class="hljs-title">extends</span> <span class="hljs-title">BusEvent</span>&gt;(<span class="hljs-params">
  <span class="hljs-keyword">type</span>: T,
  fn: (e: BusEnvelope&lt;T&gt;) =&gt; <span class="hljs-built_in">void</span>
</span>) </span>{
  bus.on(<span class="hljs-keyword">type</span>, fn <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>);
}

<span class="hljs-comment">/**
 * Unsubscribe from an event type
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">offBus</span>&lt;<span class="hljs-title">T</span> <span class="hljs-title">extends</span> <span class="hljs-title">BusEvent</span>&gt;(<span class="hljs-params">
  <span class="hljs-keyword">type</span>: T,
  fn: (e: BusEnvelope&lt;T&gt;) =&gt; <span class="hljs-built_in">void</span>
</span>) </span>{
  (bus <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).off
    ? (bus <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).off(<span class="hljs-keyword">type</span>, fn <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>)
    : bus.removeListener(<span class="hljs-keyword">type</span>, fn <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>);
}
</div></code></pre>
<h4 id="613-usage-in-api-routes">6.1.3 Usage in API Routes</h4>
<pre class="hljs"><code><div><span class="hljs-comment">// Example: Emitting after a dialogue move is created</span>
<span class="hljs-comment">// app/api/dialogue/moves/route.ts</span>

<span class="hljs-keyword">import</span> { emitBus } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/lib/server/bus"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">POST</span>(<span class="hljs-params">req: NextRequest</span>) </span>{
  <span class="hljs-comment">// ... create move in database</span>
  
  <span class="hljs-comment">// Emit event</span>
  emitBus(<span class="hljs-string">"dialogue:moves:refresh"</span>, {
    deliberationId: move.deliberationId,
    moveId: move.id,
    kind: move.kind,
  });
  
  <span class="hljs-keyword">return</span> NextResponse.json({ ok: <span class="hljs-literal">true</span>, move });
}
</div></code></pre>
<h3 id="62-sse-endpoint">6.2 SSE Endpoint</h3>
<p><strong>File:</strong> <code>app/api/events/route.ts</code></p>
<p>The Server-Sent Events endpoint that broadcasts events to connected clients.</p>
<h4 id="621-ring-buffer">6.2.1 Ring Buffer</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">type</span> FeedEvent = { id: <span class="hljs-built_in">string</span>; ts: <span class="hljs-built_in">number</span>; <span class="hljs-keyword">type</span>: <span class="hljs-built_in">string</span>; [k: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span> };

<span class="hljs-comment">// In-memory circular buffer for event history</span>
<span class="hljs-keyword">const</span> RING = (globalThis <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).__agoraRing__ ??= { 
  buf: [] <span class="hljs-keyword">as</span> FeedEvent[], 
  cap: <span class="hljs-number">2048</span> 
};
<span class="hljs-keyword">let</span> seq = (globalThis <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).__agoraSeq__ ??= <span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pushRing</span>(<span class="hljs-params">e: Omit&lt;FeedEvent, 'id'&gt;</span>): <span class="hljs-title">FeedEvent</span> </span>{
  <span class="hljs-keyword">const</span> full = { ...e, id: <span class="hljs-built_in">String</span>(++seq) };
  RING.buf.push(full);
  <span class="hljs-keyword">if</span> (RING.buf.length &gt; RING.cap) RING.buf.shift(); <span class="hljs-comment">// FIFO eviction</span>
  <span class="hljs-keyword">return</span> full;
}
</div></code></pre>
<h4 id="622-sse-response-stream">6.2.2 SSE Response Stream</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GET</span>(<span class="hljs-params">req: NextRequest</span>) </span>{
  <span class="hljs-keyword">const</span> { readable, writable } = <span class="hljs-keyword">new</span> TransformStream();
  <span class="hljs-keyword">const</span> writer = writable.getWriter();
  <span class="hljs-keyword">const</span> enc = <span class="hljs-function">(<span class="hljs-params">s: <span class="hljs-built_in">string</span></span>) =&gt;</span> writer.write(<span class="hljs-keyword">new</span> TextEncoder().encode(s));

  <span class="hljs-keyword">const</span> headers = {
    <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/event-stream; charset=utf-8'</span>,
    <span class="hljs-string">'Cache-Control'</span>: <span class="hljs-string">'no-cache, no-transform'</span>,
    Connection: <span class="hljs-string">'keep-alive'</span>,
  } <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;

  <span class="hljs-comment">// Handle reconnection with last-event-id</span>
  <span class="hljs-keyword">const</span> url = <span class="hljs-keyword">new</span> URL(req.url);
  <span class="hljs-keyword">const</span> lastQ = url.searchParams.get(<span class="hljs-string">'lastEventId'</span>);
  <span class="hljs-keyword">const</span> lastH = req.headers.get(<span class="hljs-string">'last-event-id'</span>);
  <span class="hljs-keyword">const</span> last = lastQ ?? lastH ?? <span class="hljs-literal">undefined</span>;

  <span class="hljs-comment">// Replay missed events</span>
  <span class="hljs-keyword">if</span> (last) {
    <span class="hljs-keyword">const</span> sinceId = <span class="hljs-built_in">Number</span>(last);
    <span class="hljs-keyword">const</span> backlog = RING.buf.filter(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-built_in">Number</span>(e.id) &gt; sinceId);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> e of backlog) {
      <span class="hljs-keyword">await</span> enc(<span class="hljs-string">`id: <span class="hljs-subst">${e.id}</span>\n`</span>);
      <span class="hljs-keyword">await</span> enc(<span class="hljs-string">`event: <span class="hljs-subst">${e.<span class="hljs-keyword">type</span>}</span>\n`</span>);
      <span class="hljs-keyword">await</span> enc(<span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(e)}</span>\n\n`</span>);
    }
  }

  <span class="hljs-comment">// Set retry interval hint</span>
  <span class="hljs-keyword">await</span> enc(<span class="hljs-string">`retry: 10000\n\n`</span>);

  <span class="hljs-comment">// Heartbeat every 20 seconds</span>
  <span class="hljs-keyword">const</span> beat = setInterval(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> enc(<span class="hljs-string">`:hb <span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>\n\n`</span>).catch(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {}), <span class="hljs-number">20</span>_000);

  <span class="hljs-comment">// Event handler</span>
  <span class="hljs-keyword">const</span> handler = <span class="hljs-keyword">async</span> (msg: <span class="hljs-built_in">any</span>) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> payload = msg &amp;&amp; <span class="hljs-keyword">typeof</span> msg === <span class="hljs-string">'object'</span> ? { ...msg } : {};
      <span class="hljs-keyword">const</span> <span class="hljs-keyword">type</span> = payload.type || <span class="hljs-string">'message'</span>;
      <span class="hljs-keyword">const</span> ts = <span class="hljs-built_in">Number</span>.isFinite(payload.ts) ? payload.ts : <span class="hljs-built_in">Date</span>.now();
      <span class="hljs-keyword">const</span> full = pushRing({ ts, <span class="hljs-keyword">type</span>, ...payload });
      <span class="hljs-keyword">await</span> enc(<span class="hljs-string">`id: <span class="hljs-subst">${full.id}</span>\n`</span>);
      <span class="hljs-keyword">await</span> enc(<span class="hljs-string">`event: <span class="hljs-subst">${full.<span class="hljs-keyword">type</span>}</span>\n`</span>);
      <span class="hljs-keyword">await</span> enc(<span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(full)}</span>\n\n`</span>);
    } <span class="hljs-keyword">catch</span> {
      close();
    }
  };

  <span class="hljs-comment">// Subscribe to all event types</span>
  BUS_EVENTS.forEach(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> onBus(t, handler));

  <span class="hljs-comment">// Cleanup on disconnect</span>
  <span class="hljs-keyword">const</span> close = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    clearInterval(beat);
    <span class="hljs-keyword">try</span> { BUS_EVENTS.forEach(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> offBus(t, handler)); } <span class="hljs-keyword">catch</span> {}
    <span class="hljs-keyword">try</span> { writer.close(); } <span class="hljs-keyword">catch</span> {}
  };

  req.signal.addEventListener(<span class="hljs-string">'abort'</span>, close);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> NextResponse(readable <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>, { headers });
}
</div></code></pre>
<h3 id="63-liveeventsprovider">6.3 LiveEventsProvider</h3>
<p><strong>File:</strong> <code>app/agora/LiveEventsProvider.tsx</code> (~170 lines)</p>
<p>Client-side SSE consumer wrapped around the app layout.</p>
<h4 id="631-topics-configuration">6.3.1 Topics Configuration</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> TOPICS = [
  <span class="hljs-string">'dialogue:moves:refresh'</span>,
  <span class="hljs-string">'dialogue:cs:refresh'</span>,
  <span class="hljs-string">'claims:edges:changed'</span>,
  <span class="hljs-string">'cqs:changed'</span>,
  <span class="hljs-string">'cards:changed'</span>,
  <span class="hljs-string">'decision:changed'</span>,
  <span class="hljs-string">'votes:changed'</span>,
  <span class="hljs-string">'stacks:changed'</span>,
  <span class="hljs-string">'deliberations:created'</span>,
  <span class="hljs-string">'comments:changed'</span>,
  <span class="hljs-string">'xref:changed'</span>,
  <span class="hljs-string">'citations:changed'</span>,
  <span class="hljs-string">'dialogue:changed'</span>
] <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;
</div></code></pre>
<h4 id="632-swr-revalidation-map">6.3.2 SWR Revalidation Map</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">const</span> KEYMAP: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-function">(<span class="hljs-params">ev: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">string</span>[]&gt; = {
  <span class="hljs-string">'dialogue:moves:refresh'</span>: <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span>
    e?.deliberationId 
      ? [<span class="hljs-string">`/api/dialogue/moves?deliberationId=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(e.deliberationId)}</span>`</span>] 
      : [],
  <span class="hljs-string">'dialogue:changed'</span>: <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span>
    e?.deliberationId 
      ? [<span class="hljs-string">`/api/ludics/orthogonal?dialogueId=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(e.deliberationId)}</span>`</span>] 
      : [],
  <span class="hljs-string">'citations:changed'</span>: <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span>
    e?.targetId 
      ? [<span class="hljs-string">`/api/claims/<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(e.targetId)}</span>/evidence`</span>] 
      : [],
  <span class="hljs-string">'decision:changed'</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> 
    [<span class="hljs-string">'/api/hub/deliberations'</span>, <span class="hljs-string">'/api/agora/events?since=bootstrap'</span>],
  <span class="hljs-string">'comments:changed'</span>: <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span>
    e?.discussionId 
      ? [<span class="hljs-string">`/api/discussions/<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(e.discussionId)}</span>/forum`</span>] 
      : [],
};
</div></code></pre>
<h4 id="633-safety-backfill-hook">6.3.3 Safety Backfill Hook</h4>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">useSafetyBackfill</span>(<span class="hljs-params">onEvent: (e: AnyEvent) =&gt; <span class="hljs-built_in">void</span></span>) </span>{
  <span class="hljs-keyword">const</span> lastTsRef = useRef&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-number">0</span>);

  useEffect(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> kick = <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> url = lastTsRef.current
          ? <span class="hljs-string">`/api/agora/events?since=<span class="hljs-subst">${lastTsRef.current}</span>`</span>
          : <span class="hljs-string">`/api/agora/events?limit=0`</span>;
        <span class="hljs-keyword">const</span> r = <span class="hljs-keyword">await</span> fetch(url, { cache: <span class="hljs-string">'no-store'</span> });
        <span class="hljs-keyword">if</span> (!r.ok) <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">const</span> j = <span class="hljs-keyword">await</span> r.json();
        <span class="hljs-keyword">const</span> items: AnyEvent[] = <span class="hljs-built_in">Array</span>.isArray(j?.items) ? j.items : [];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> e of items) {
          onEvent(e);
          <span class="hljs-keyword">if</span> (e.ts &amp;&amp; e.ts &gt; lastTsRef.current) lastTsRef.current = e.ts;
        }
      } <span class="hljs-keyword">catch</span> {}
    };

    <span class="hljs-comment">// Triggers</span>
    <span class="hljs-keyword">const</span> onVis = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> { <span class="hljs-keyword">if</span> (<span class="hljs-built_in">document</span>.visibilityState === <span class="hljs-string">'visible'</span>) kick(); };
    <span class="hljs-keyword">const</span> onOnline = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> kick();

    <span class="hljs-comment">// Periodic polling (60 second safety net)</span>
    <span class="hljs-keyword">const</span> id = setInterval(kick, <span class="hljs-number">60</span>_000);
    <span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">'visibilitychange'</span>, onVis);
    <span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">'online'</span>, onOnline);

    kick(); <span class="hljs-comment">// Initial check</span>

    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      clearInterval(id);
      <span class="hljs-built_in">document</span>.removeEventListener(<span class="hljs-string">'visibilitychange'</span>, onVis);
      <span class="hljs-built_in">window</span>.removeEventListener(<span class="hljs-string">'online'</span>, onOnline);
    };
  }, [onEvent]);
}
</div></code></pre>
<h4 id="634-provider-component">6.3.4 Provider Component</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">LiveEventsProvider</span>(<span class="hljs-params">{ children }: { children: React.ReactNode }</span>) </span>{
  <span class="hljs-keyword">const</span> bufRef = useRef&lt;<span class="hljs-built_in">any</span>[]&gt;([]);
  <span class="hljs-keyword">const</span> lastIdRef = useRef&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>&gt;(
    <span class="hljs-keyword">typeof</span> sessionStorage !== <span class="hljs-string">'undefined'</span> 
      ? sessionStorage.getItem(<span class="hljs-string">'agora:lastEventId'</span>) 
      : <span class="hljs-literal">null</span>
  );

  <span class="hljs-keyword">const</span> handle = useCallback(<span class="hljs-function">(<span class="hljs-params">raw: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
    <span class="hljs-keyword">let</span> ev: AnyEvent | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">try</span> { ev = <span class="hljs-keyword">typeof</span> raw === <span class="hljs-string">'string'</span> ? <span class="hljs-built_in">JSON</span>.parse(raw) : raw; } <span class="hljs-keyword">catch</span> {}
    <span class="hljs-keyword">if</span> (!ev || !ev.type) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 1) Coalesce for local buffer</span>
    bufRef.current = coalesce(bufRef.current, ev);

    <span class="hljs-comment">// 2) Trigger SWR revalidation</span>
    <span class="hljs-keyword">const</span> keys = <span class="hljs-keyword">new</span> Set(KEYMAP[ev.type]?.(ev) ?? []);
    <span class="hljs-keyword">if</span> (keys.size) {
      queueMicrotask(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> k of keys) swrMutate(k, <span class="hljs-literal">undefined</span>, { revalidate: <span class="hljs-literal">true</span> });
      });
    }

    <span class="hljs-comment">// 3) Legacy bridge (until all consumers migrate)</span>
    <span class="hljs-keyword">try</span> { <span class="hljs-built_in">window</span>.dispatchEvent(<span class="hljs-keyword">new</span> CustomEvent(ev.type, { detail: ev })); } <span class="hljs-keyword">catch</span> {}
  }, []);

  useSafetyBackfill(handle);

  useEffect(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> qs = lastIdRef.current 
      ? <span class="hljs-string">`?lastEventId=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(lastIdRef.current)}</span>`</span> 
      : <span class="hljs-string">''</span>;
    <span class="hljs-keyword">const</span> es = <span class="hljs-keyword">new</span> EventSource(<span class="hljs-string">`/api/events<span class="hljs-subst">${qs}</span>`</span>);

    <span class="hljs-keyword">const</span> saveId = <span class="hljs-function">(<span class="hljs-params">id?: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span></span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!id) <span class="hljs-keyword">return</span>;
      lastIdRef.current = <span class="hljs-built_in">String</span>(id);
      <span class="hljs-keyword">try</span> { sessionStorage.setItem(<span class="hljs-string">'agora:lastEventId'</span>, <span class="hljs-built_in">String</span>(id)); } <span class="hljs-keyword">catch</span> {}
    };

    <span class="hljs-comment">// Default message handler</span>
    es.onmessage = <span class="hljs-function">(<span class="hljs-params">ev: MessageEvent</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> id = (ev <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>)?.lastEventId || (ev <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>)?.id;
      <span class="hljs-keyword">if</span> (id) saveId(id);
      handle(ev.data);
    };

    <span class="hljs-comment">// Named topic handlers</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> t of TOPICS) {
      es.addEventListener(t, <span class="hljs-function">(<span class="hljs-params">ev: MessageEvent</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> id = (ev <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>)?.lastEventId || (ev <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>)?.id;
        <span class="hljs-keyword">if</span> (id) saveId(id);
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">const</span> j = <span class="hljs-built_in">JSON</span>.parse(ev.data <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>);
          <span class="hljs-keyword">const</span> flat = j?.payload &amp;&amp; <span class="hljs-keyword">typeof</span> j.payload === <span class="hljs-string">'object'</span>
            ? { <span class="hljs-keyword">type</span>: t, ...j.payload }
            : { <span class="hljs-keyword">type</span>: t, ...j };
          handle(flat);
        } <span class="hljs-keyword">catch</span> {}
      });
    }

    es.onerror = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> { <span class="hljs-comment">/* auto-reconnect built-in */</span> };

    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> es.close();
  }, [handle]);

  <span class="hljs-keyword">return</span> &lt;&gt;{children}&lt;<span class="hljs-regexp">/&gt;;
}
</span></div></code></pre>
<h3 id="64-usebuseffect-hook">6.4 useBusEffect Hook</h3>
<p><strong>File:</strong> <code>lib/client/useBusEffect.ts</code> (~140 lines)</p>
<p>Reusable hook for subscribing to SSE events.</p>
<h4 id="641-hook-signature">6.4.1 Hook Signature</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">useBusEffect</span>&lt;<span class="hljs-title">T</span> <span class="hljs-title">extends</span> <span class="hljs-title">BusEvent</span> = <span class="hljs-title">BusEvent</span>&gt;(<span class="hljs-params">
  topics: Topics&lt;T&gt;,           <span class="hljs-comment">// "*" | "all" | BusEvent[]</span>
  handler: (e: BusEnvelope&lt;T&gt;) =&gt; <span class="hljs-built_in">void</span>,
  opts: Options = {}
</span>)
</span></div></code></pre>
<h4 id="642-options">6.4.2 Options</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">type</span> Options = {
  url?: <span class="hljs-built_in">string</span>;              <span class="hljs-comment">// SSE endpoint (default: "/api/events")</span>
  withCredentials?: <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// CORS credentials</span>
  retry?: <span class="hljs-built_in">boolean</span>;           <span class="hljs-comment">// Auto-retry on error</span>
  maxRetryDelayMs?: <span class="hljs-built_in">number</span>;  <span class="hljs-comment">// Max backoff (default: 30000)</span>
};
</div></code></pre>
<h4 id="643-normalization">6.4.3 Normalization</h4>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">normalize</span>&lt;<span class="hljs-title">T</span> <span class="hljs-title">extends</span> <span class="hljs-title">BusEvent</span>&gt;(<span class="hljs-params">
  raw: <span class="hljs-built_in">any</span>, 
  fallbackType?: T
</span>): <span class="hljs-title">BusEnvelope</span>&lt;<span class="hljs-title">T</span>&gt; | <span class="hljs-title">null</span> </span>{
  <span class="hljs-keyword">if</span> (!raw) <span class="hljs-keyword">return</span> fallbackType ? { <span class="hljs-keyword">type</span>: fallbackType, ts: <span class="hljs-built_in">Date</span>.now() } <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span> : <span class="hljs-literal">null</span>;

  <span class="hljs-comment">// Top-level type present</span>
  <span class="hljs-keyword">if</span> (raw.type) {
    <span class="hljs-keyword">if</span> (raw.payload &amp;&amp; <span class="hljs-keyword">typeof</span> raw.payload === <span class="hljs-string">'object'</span>) {
      <span class="hljs-keyword">return</span> { <span class="hljs-keyword">type</span>: raw.type, ...raw.payload } <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;
    }
    <span class="hljs-keyword">return</span> raw <span class="hljs-keyword">as</span> BusEnvelope&lt;T&gt;;
  }

  <span class="hljs-comment">// Fallback for named SSE events</span>
  <span class="hljs-keyword">if</span> (fallbackType) {
    <span class="hljs-keyword">if</span> (raw.payload &amp;&amp; <span class="hljs-keyword">typeof</span> raw.payload === <span class="hljs-string">'object'</span>) {
      <span class="hljs-keyword">return</span> { <span class="hljs-keyword">type</span>: fallbackType, ...raw.payload } <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;
    }
    <span class="hljs-keyword">return</span> { <span class="hljs-keyword">type</span>: fallbackType, ...raw } <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</div></code></pre>
<h4 id="644-usage-example">6.4.4 Usage Example</h4>
<pre class="hljs"><code><div><span class="hljs-comment">// In Agora.tsx</span>
useBusEffect(<span class="hljs-string">"*"</span>, <span class="hljs-function">(<span class="hljs-params">m</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (paused) <span class="hljs-keyword">return</span>;
  
  <span class="hljs-keyword">const</span> ev = transformToAgoraEvent(m);
  <span class="hljs-keyword">if</span> (ev) {
    setEvents(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> coalesce(prev, ev).slice(<span class="hljs-number">0</span>, <span class="hljs-number">200</span>));
  }
});

<span class="hljs-comment">// In CriticalQuestionsV3.tsx</span>
useBusEffect(
  [<span class="hljs-string">"cqs:changed"</span>, <span class="hljs-string">"claims:edges:changed"</span>],
  <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (e.deliberationId === currentDeliberationId) {
      mutate(); <span class="hljs-comment">// Refresh SWR data</span>
    }
  }
);
</div></code></pre>
<hr>
<h2 id="7-api-specifications">7. API Specifications</h2>
<h3 id="71-sse-events-endpoint">7.1 SSE Events Endpoint</h3>
<h4 id="get-apievents">GET <code>/api/events</code></h4>
<p>Server-Sent Events endpoint for real-time updates.</p>
<p><strong>Headers:</strong></p>
<pre class="hljs"><code><div>Content-Type: text/event-stream; charset=utf-8
Cache-Control: no-cache, no-transform
Connection: keep-alive
</div></code></pre>
<p><strong>Query Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>lastEventId</code></td>
<td>string</td>
<td>Resume from this event ID (optional)</td>
</tr>
</tbody>
</table>
<p><strong>Request Header:</strong></p>
<table>
<thead>
<tr>
<th>Header</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Last-Event-ID</code></td>
<td>Alternative to query param for resume</td>
</tr>
</tbody>
</table>
<p><strong>SSE Message Format:</strong></p>
<pre class="hljs"><code><div>id: 123
event: dialogue:changed
data: {&quot;type&quot;:&quot;dialogue:changed&quot;,&quot;ts&quot;:1704067200000,&quot;deliberationId&quot;:&quot;abc123&quot;,...}

</div></code></pre>
<p><strong>Event Types Emitted:</strong>
All events from <code>BUS_EVENTS</code> are broadcast on this endpoint.</p>
<p><strong>Heartbeat:</strong></p>
<pre class="hljs"><code><div>:hb 1704067200000

</div></code></pre>
<p>Sent every 20 seconds to keep connection alive.</p>
<h3 id="72-agora-events-endpoint">7.2 Agora Events Endpoint</h3>
<h4 id="get-apiagoraevents">GET <code>/api/agora/events</code></h4>
<p>Fetch historical events with optional filtering.</p>
<p><strong>Query Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>limit</code></td>
<td>number</td>
<td>30</td>
<td>Max events to return (max 100)</td>
</tr>
<tr>
<td><code>since</code></td>
<td>number</td>
<td>0</td>
<td>Timestamp filter (epoch ms)</td>
</tr>
</tbody>
</table>
<p><strong>Response:</strong></p>
<pre class="hljs"><code><div>{
  items: AgoraEvent[];
}
</div></code></pre>
<p><strong>Data Sources:</strong></p>
<ul>
<li><code>DialogueMove</code> - Recent moves (60% of limit)</li>
<li><code>Citation</code> - Recent citations (30% of limit)</li>
<li><code>LudicDecisionReceipt</code> - Recent decisions (30% of limit)</li>
</ul>
<h3 id="73-network-endpoint">7.3 Network Endpoint</h3>
<h4 id="get-apiagoranetwork">GET <code>/api/agora/network</code></h4>
<p>Get room network graph for Plexus visualization.</p>
<p><strong>Query Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>scope</code></td>
<td>string</td>
<td>&quot;public&quot;</td>
<td>&quot;public&quot; or &quot;following&quot;</td>
</tr>
<tr>
<td><code>maxRooms</code></td>
<td>number</td>
<td>80</td>
<td>Maximum rooms to return (max 500)</td>
</tr>
</tbody>
</table>
<p><strong>Response:</strong></p>
<pre class="hljs"><code><div>{
  scope: <span class="hljs-string">"public"</span> | <span class="hljs-string">"following"</span>;
  version: <span class="hljs-built_in">number</span>;     <span class="hljs-comment">// Cache invalidation timestamp</span>
  rooms: RoomNode[];
  edges: MetaEdge[];
}
</div></code></pre>
<p><strong>Room Data:</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">type</span> RoomNode = {
  id: <span class="hljs-built_in">string</span>;
  title: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>;
  nArgs: <span class="hljs-built_in">number</span>;       <span class="hljs-comment">// Argument count</span>
  nEdges: <span class="hljs-built_in">number</span>;      <span class="hljs-comment">// ArgumentEdge count</span>
  accepted: <span class="hljs-built_in">number</span>;    <span class="hljs-comment">// Claims with label='IN'</span>
  rejected: <span class="hljs-built_in">number</span>;    <span class="hljs-comment">// Claims with label='OUT'</span>
  undecided: <span class="hljs-built_in">number</span>;   <span class="hljs-comment">// Claims without label</span>
  tags: <span class="hljs-built_in">string</span>[];
  updatedAt: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>;
  debateSheetId: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>;
};
</div></code></pre>
<p><strong>Edge Types:</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">type</span> MetaEdge = {
  <span class="hljs-keyword">from</span>: <span class="hljs-built_in">string</span>;        <span class="hljs-comment">// Source room ID</span>
  to: <span class="hljs-built_in">string</span>;          <span class="hljs-comment">// Target room ID</span>
  kind: EdgeKind;      <span class="hljs-comment">// Edge category</span>
  weight: <span class="hljs-built_in">number</span>;      <span class="hljs-comment">// Connection strength</span>
};

<span class="hljs-keyword">type</span> EdgeKind = 
  | <span class="hljs-string">'xref'</span>            <span class="hljs-comment">// Explicit XRef record</span>
  | <span class="hljs-string">'overlap'</span>         <span class="hljs-comment">// Shared claim text</span>
  | <span class="hljs-string">'stack_ref'</span>       <span class="hljs-comment">// Reference same stack</span>
  | <span class="hljs-string">'imports'</span>         <span class="hljs-comment">// RoomFunctor mapping</span>
  | <span class="hljs-string">'shared_author'</span>;  <span class="hljs-comment">// Common contributors</span>
</div></code></pre>
<h3 id="74-rooms-endpoint">7.4 Rooms Endpoint</h3>
<h4 id="get-apiagorarooms">GET <code>/api/agora/rooms</code></h4>
<p>List all agora rooms.</p>
<p><strong>Response:</strong></p>
<pre class="hljs"><code><div>{
  items: <span class="hljs-built_in">Array</span>&lt;{
    id: <span class="hljs-built_in">string</span>;
    slug: <span class="hljs-built_in">string</span>;
    title: <span class="hljs-built_in">string</span>;
    summary: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>;
    updatedAt: <span class="hljs-built_in">string</span>;
    nDeliberations: <span class="hljs-built_in">number</span>;   <span class="hljs-comment">// Count of deliberations in room</span>
  }&gt;;
}
</div></code></pre>
<h3 id="75-room-deliberations-endpoint">7.5 Room Deliberations Endpoint</h3>
<h4 id="get-apiagoraroomsiddeliberations">GET <code>/api/agora/rooms/[id]/deliberations</code></h4>
<p>Get deliberations within a specific room.</p>
<p><strong>Path Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>string</td>
<td>Room ID</td>
</tr>
</tbody>
</table>
<p><strong>Response:</strong></p>
<pre class="hljs"><code><div>{
  items: <span class="hljs-built_in">Array</span>&lt;{
    id: <span class="hljs-built_in">string</span>;
    title: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>;
    hostType: <span class="hljs-built_in">string</span>;
    hostId: <span class="hljs-built_in">string</span>;
    createdAt: <span class="hljs-built_in">string</span>;
    updatedAt: <span class="hljs-built_in">string</span>;
  }&gt;;
}
</div></code></pre>
<h3 id="76-follow-endpoint">7.6 Follow Endpoint</h3>
<h4 id="get-apifollow">GET <code>/api/follow</code></h4>
<p>Get user's followed rooms and tags.</p>
<p><strong>Query Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>kind</code></td>
<td>string</td>
<td>Filter by &quot;room&quot; or &quot;tag&quot; (optional)</td>
</tr>
</tbody>
</table>
<p><strong>Response:</strong></p>
<pre class="hljs"><code><div>{
  items: <span class="hljs-built_in">Array</span>&lt;{
    userId: <span class="hljs-built_in">string</span>;
    kind: <span class="hljs-string">"room"</span> | <span class="hljs-string">"tag"</span>;
    targetId: <span class="hljs-built_in">string</span>;
    createdAt: <span class="hljs-built_in">string</span>;
  }&gt;;
}
</div></code></pre>
<h4 id="post-apifollow">POST <code>/api/follow</code></h4>
<p>Follow a room or tag.</p>
<p><strong>Request Body:</strong></p>
<pre class="hljs"><code><div>{
  kind: <span class="hljs-string">"room"</span> | <span class="hljs-string">"tag"</span>;
  targetId: <span class="hljs-built_in">string</span>;
}
</div></code></pre>
<p><strong>Response:</strong></p>
<pre class="hljs"><code><div>{ ok: <span class="hljs-literal">true</span> }
</div></code></pre>
<h4 id="delete-apifollow">DELETE <code>/api/follow</code></h4>
<p>Unfollow a room or tag.</p>
<p><strong>Query Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>kind</code></td>
<td>string</td>
<td>&quot;room&quot; or &quot;tag&quot;</td>
</tr>
<tr>
<td><code>targetId</code></td>
<td>string</td>
<td>Room ID or tag string</td>
</tr>
</tbody>
</table>
<p><strong>Response:</strong></p>
<pre class="hljs"><code><div>{ ok: <span class="hljs-literal">true</span> }
</div></code></pre>
<h3 id="77-edge-metadata-endpoint">7.7 Edge Metadata Endpoint</h3>
<h4 id="get-apiagoraedge-metadata">GET <code>/api/agora/edge-metadata</code></h4>
<p>Get detailed metadata for Plexus edges.</p>
<p><strong>Query Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>from</code></td>
<td>string</td>
<td>Source room ID</td>
</tr>
<tr>
<td><code>to</code></td>
<td>string</td>
<td>Target room ID</td>
</tr>
<tr>
<td><code>kind</code></td>
<td>EdgeKind</td>
<td>Edge type</td>
</tr>
</tbody>
</table>
<p><strong>Response:</strong></p>
<pre class="hljs"><code><div>{
  ok: <span class="hljs-built_in">boolean</span>;
  kind: EdgeKind;
  <span class="hljs-comment">// For 'imports':</span>
  mappings?: <span class="hljs-built_in">Array</span>&lt;{ fromClaim: <span class="hljs-built_in">string</span>; toClaim: <span class="hljs-built_in">string</span> }&gt;;
  <span class="hljs-comment">// For 'shared_author':</span>
  authors?: <span class="hljs-built_in">Array</span>&lt;{ id: <span class="hljs-built_in">string</span>; name: <span class="hljs-built_in">string</span> }&gt;;
  <span class="hljs-comment">// Additional metadata based on kind</span>
}
</div></code></pre>
<h3 id="78-hub-deliberations-endpoint">7.8 Hub Deliberations Endpoint</h3>
<h4 id="get-apihubdeliberations">GET <code>/api/hub/deliberations</code></h4>
<p>Discover deliberations with search and filtering.</p>
<p><strong>Query Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>q</code></td>
<td>string</td>
<td>Search query</td>
</tr>
<tr>
<td><code>calls</code></td>
<td>string</td>
<td>&quot;any&quot; or &quot;open&quot; (has open calls)</td>
</tr>
<tr>
<td><code>tags</code></td>
<td>string</td>
<td>Comma-separated tag filter</td>
</tr>
</tbody>
</table>
<p><strong>Response:</strong></p>
<pre class="hljs"><code><div>{
  items: <span class="hljs-built_in">Array</span>&lt;{
    id: <span class="hljs-built_in">string</span>;
    title: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>;
    host: { <span class="hljs-keyword">type</span>: <span class="hljs-built_in">string</span> } | <span class="hljs-literal">null</span>;
    tags: <span class="hljs-built_in">string</span>[];
    call: { description: <span class="hljs-built_in">string</span> } | <span class="hljs-literal">null</span>;
    stats: {
      claims: <span class="hljs-built_in">number</span>;
      openCQs: <span class="hljs-built_in">number</span>;
    };
    updatedAt: <span class="hljs-built_in">string</span>;
  }&gt;;
}
</div></code></pre>
<h3 id="79-xref-endpoint">7.9 XRef Endpoint</h3>
<h4 id="get-apixref">GET <code>/api/xref</code></h4>
<p>Query cross-references (backlinks).</p>
<p><strong>Query Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>toType</code></td>
<td>string</td>
<td>Target entity type (e.g., &quot;deliberation&quot;)</td>
</tr>
<tr>
<td><code>toId</code></td>
<td>string</td>
<td>Target entity ID</td>
</tr>
</tbody>
</table>
<p><strong>Response:</strong></p>
<pre class="hljs"><code><div>{
  items: <span class="hljs-built_in">Array</span>&lt;{
    id: <span class="hljs-built_in">string</span>;
    fromType: <span class="hljs-built_in">string</span>;
    fromId: <span class="hljs-built_in">string</span>;
    toType: <span class="hljs-built_in">string</span>;
    toId: <span class="hljs-built_in">string</span>;
    relation: <span class="hljs-built_in">string</span>;
  }&gt;;
}
</div></code></pre>
<hr>
<h2 id="8-plexus-visualization-system">8. Plexus Visualization System</h2>
<h3 id="81-system-overview">8.1 System Overview</h3>
<p>Plexus is the room relationship visualization subsystem, providing three view modes for exploring how deliberations connect across the platform.</p>
<pre class="hljs"><code><div>┌─────────────────────────────────────────────────────────────────────────┐
│                      PLEXUS ARCHITECTURE                                │
└─────────────────────────────────────────────────────────────────────────┘

                    PlexusShell (Agora.tsx)
                           │
           ┌───────────────┼───────────────┐
           ▼               ▼               ▼
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │ PlexusBoard │ │   Plexus    │ │PlexusMatrix │
    │  (Card Grid)│ │ (Force Dir) │ │ (Adjacency) │
    └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
           │               │               │
           └───────────────┼───────────────┘
                           │
                           ▼
               ┌───────────────────────┐
               │  /api/agora/network   │
               │  Fetches rooms/edges  │
               └───────────────────────┘
</div></code></pre>
<h3 id="82-plexusshell-component">8.2 PlexusShell Component</h3>
<p><strong>File:</strong> <code>app/agora/ui/Agora.tsx</code> (lines 106-210)</p>
<p>Wrapper component that provides view mode switching.</p>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">PlexusShell</span>(<span class="hljs-params">{ scope }: { scope: '<span class="hljs-keyword">public</span>' | 'following' }</span>) </span>{
  <span class="hljs-keyword">const</span> [view, setView] = useState&lt;<span class="hljs-string">'board'</span> | <span class="hljs-string">'graph'</span> | <span class="hljs-string">'matrix'</span>&gt;(<span class="hljs-string">'board'</span>);

  <span class="hljs-keyword">return</span> (
    &lt;div&gt;
      {<span class="hljs-comment">/* View mode selector */</span>}
      &lt;div className=<span class="hljs-string">"flex items-center gap-2 p-2 border-b"</span>&gt;
        &lt;span className=<span class="hljs-string">"text-sm text-neutral-600"</span>&gt;View:&lt;<span class="hljs-regexp">/span&gt;
        {(['board', 'graph', 'matrix'] as const).map((v) =&gt; (
          &lt;button
            key={v}
            className={clsx('px-3 py-1 text-sm rounded', 
              view === v ? 'bg-slate-900 text-white' : 'hover:bg-slate-100'
            )}
            onClick={() =&gt; setView(v)}
          &gt;
            {v}
          &lt;/</span>button&gt;
        ))}
      &lt;<span class="hljs-regexp">/div&gt;

      {/</span>* Conditional view rendering *<span class="hljs-regexp">/}
      {view === 'board'  &amp;&amp; &lt;PlexusBoard scope={scope} /</span>&gt;}
      {view === <span class="hljs-string">'graph'</span>  &amp;&amp; &lt;Plexus scope={scope} /&gt;}
      {view === <span class="hljs-string">'matrix'</span> &amp;&amp; &lt;PlexusMatrix scope={scope} /&gt;}
    &lt;<span class="hljs-regexp">/div&gt;
  );
}
</span></div></code></pre>
<h3 id="83-plexus-force-directed-graph">8.3 Plexus (Force-Directed Graph)</h3>
<p><strong>File:</strong> <code>components/agora/Plexus.tsx</code> (1010 lines)</p>
<p>Interactive node-link visualization of room network.</p>
<h4 id="831-key-features">8.3.1 Key Features</h4>
<ul>
<li><strong>Force-directed layout</strong> - Nodes repel, edges attract</li>
<li><strong>Edge filtering</strong> - Toggle edge types on/off</li>
<li><strong>Confidence gating</strong> - Filter by DS/min/product confidence</li>
<li><strong>Edge bundling</strong> - Combine parallel edges</li>
<li><strong>Room selection</strong> - Click to select, hover for preview</li>
<li><strong>Link sketching</strong> - Draw new edges between rooms</li>
<li><strong>Metadata tooltips</strong> - Hover edge for detailed info</li>
</ul>
<h4 id="832-state-management">8.3.2 State Management</h4>
<pre class="hljs"><code><div><span class="hljs-comment">// Filter state (persisted to localStorage)</span>
<span class="hljs-keyword">const</span> [edgeOn, setEdgeOn] = usePersistentState&lt;Record&lt;EdgeKind, <span class="hljs-built_in">boolean</span>&gt;&gt;(
  <span class="hljs-string">'plexus:edgeOn'</span>,
  { xref: <span class="hljs-literal">true</span>, overlap: <span class="hljs-literal">true</span>, stack_ref: <span class="hljs-literal">true</span>, imports: <span class="hljs-literal">true</span>, shared_author: <span class="hljs-literal">false</span> }
);
<span class="hljs-keyword">const</span> [bundleEdges, setBundleEdges] = usePersistentState&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-string">'plexus:bundle'</span>, <span class="hljs-literal">true</span>);
<span class="hljs-keyword">const</span> [orderBy, setOrderBy] = usePersistentState&lt;OrderBy&gt;(<span class="hljs-string">'plexus:order'</span>, <span class="hljs-string">'recent'</span>);
<span class="hljs-keyword">const</span> [labelMode, setLabelMode] = usePersistentState&lt;LabelMode&gt;(<span class="hljs-string">'plexus:labels'</span>, <span class="hljs-string">'auto'</span>);
<span class="hljs-keyword">const</span> [q, setQ] = usePersistentState&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">'plexus:q'</span>, <span class="hljs-string">''</span>);

<span class="hljs-comment">// Selection state</span>
<span class="hljs-keyword">const</span> [sel, setSel] = useState&lt;<span class="hljs-built_in">string</span>[]&gt;([]); <span class="hljs-comment">// Up to 2 rooms for link creation</span>
<span class="hljs-keyword">const</span> [hoverRoom, setHoverRoom] = useState&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
<span class="hljs-keyword">const</span> [hoverEdge, setHoverEdge] = useState&lt;MetaEdge | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
<span class="hljs-keyword">const</span> [edgeMetadata, setEdgeMetadata] = useState&lt;<span class="hljs-built_in">any</span>&gt;(<span class="hljs-literal">null</span>);
</div></code></pre>
<h4 id="833-confidence-integration">8.3.3 Confidence Integration</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">const</span> { mode, tau } = useConfidence();
<span class="hljs-keyword">const</span> prefetch = useRoomGraphPrefetch();

<span class="hljs-comment">// Fetch confidence-gated support percentages</span>
<span class="hljs-keyword">const</span> fetchGated = useCallback(<span class="hljs-keyword">async</span> (rid: <span class="hljs-built_in">string</span>) =&gt; {
  <span class="hljs-keyword">if</span> (gatedShare.current.has(rid)) <span class="hljs-keyword">return</span> gatedShare.current.get(rid)!;
  
  <span class="hljs-keyword">const</span> qs = <span class="hljs-keyword">new</span> URLSearchParams({ 
    semantics: <span class="hljs-string">'preferred'</span>, 
    mode, 
    ...(tau != <span class="hljs-literal">null</span> ? { confidence: <span class="hljs-built_in">String</span>(tau) } : {}) 
  });
  
  <span class="hljs-keyword">const</span> r = <span class="hljs-keyword">await</span> fetch(<span class="hljs-string">`/api/deliberations/<span class="hljs-subst">${rid}</span>/graph?<span class="hljs-subst">${qs}</span>`</span>, { cache: <span class="hljs-string">'no-store'</span> });
  <span class="hljs-keyword">const</span> g = <span class="hljs-keyword">await</span> r?.json();
  
  <span class="hljs-keyword">const</span> total = <span class="hljs-built_in">Array</span>.isArray(g?.nodes) ? g.nodes.length : <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> inCount = total ? g.nodes.filter(<span class="hljs-function">(<span class="hljs-params">n: <span class="hljs-built_in">any</span></span>) =&gt;</span> n.label === <span class="hljs-string">'IN'</span>).length : <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> share = total ? inCount / total : <span class="hljs-number">0</span>;
  
  gatedShare.current.set(rid, share);
  <span class="hljs-keyword">return</span> share;
}, [mode, tau]);
</div></code></pre>
<h4 id="834-live-event-refresh">8.3.4 Live Event Refresh</h4>
<pre class="hljs"><code><div>useEffect(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> bump = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> mutate();
  <span class="hljs-keyword">const</span> evts = [
    <span class="hljs-string">'dialogue:changed'</span>,
    <span class="hljs-string">'xref:changed'</span>,
    <span class="hljs-string">'deliberations:created'</span>,
    <span class="hljs-string">'plexus:links:changed'</span>,
    <span class="hljs-string">'roomFunctor:changed'</span>
  ];
  evts.forEach(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> <span class="hljs-built_in">window</span>.addEventListener(t, bump <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>));
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> evts.forEach(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> <span class="hljs-built_in">window</span>.removeEventListener(t, bump <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>));
}, [mutate]);
</div></code></pre>
<h4 id="835-edge-color-scheme">8.3.5 Edge Color Scheme</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">const</span> EDGE_COLORS: Record&lt;EdgeKind, <span class="hljs-built_in">string</span>&gt; = {
  xref: <span class="hljs-string">'#6366f1'</span>,          <span class="hljs-comment">// Indigo</span>
  overlap: <span class="hljs-string">'#ef4444'</span>,       <span class="hljs-comment">// Red</span>
  stack_ref: <span class="hljs-string">'#f59e0b'</span>,     <span class="hljs-comment">// Amber</span>
  imports: <span class="hljs-string">'#14b8a6'</span>,       <span class="hljs-comment">// Teal</span>
  shared_author: <span class="hljs-string">'#64748b'</span>, <span class="hljs-comment">// Slate</span>
};

<span class="hljs-keyword">const</span> EDGE_LABELS: Record&lt;EdgeKind, <span class="hljs-built_in">string</span>&gt; = {
  xref: <span class="hljs-string">'Cross‑ref'</span>,
  overlap: <span class="hljs-string">'Overlap'</span>,
  stack_ref: <span class="hljs-string">'Stack ref'</span>,
  imports: <span class="hljs-string">'Imports'</span>,
  shared_author: <span class="hljs-string">'Shared author'</span>
};
</div></code></pre>
<h3 id="84-plexusboard-card-grid">8.4 PlexusBoard (Card Grid)</h3>
<p><strong>File:</strong> <code>components/agora/PlexusBoard.tsx</code> (960 lines)</p>
<p>Card-based board view showing rooms as cards with edge lines.</p>
<h4 id="841-key-features">8.4.1 Key Features</h4>
<ul>
<li><strong>Grid layout</strong> - Responsive card arrangement</li>
<li><strong>Edge lines</strong> - SVG lines connecting related rooms</li>
<li><strong>Metrics display</strong> - Arguments, edges, acceptance rates</li>
<li><strong>Sorting options</strong> - Recent, size, acceptance, alphabetical</li>
<li><strong>Search filtering</strong> - Filter by title or tags</li>
<li><strong>Quick actions</strong> - Open room, create links</li>
</ul>
<h4 id="842-card-component">8.4.2 Card Component</h4>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RoomCard</span>(<span class="hljs-params">{ room, isSelected, onSelect, onHover }: {
  room: RoomNode;
  isSelected: <span class="hljs-built_in">boolean</span>;
  onSelect: () =&gt; <span class="hljs-built_in">void</span>;
  onHover: (hover: <span class="hljs-built_in">boolean</span>) =&gt; <span class="hljs-built_in">void</span>;
}</span>) </span>{
  <span class="hljs-keyword">const</span> total = room.accepted + room.rejected + room.undecided;
  <span class="hljs-keyword">const</span> acceptShare = total ? room.accepted / total : <span class="hljs-number">0</span>;

  <span class="hljs-keyword">return</span> (
    &lt;div
      className={clsx(
        <span class="hljs-string">"rounded-xl border p-3 cursor-pointer transition"</span>,
        isSelected ? <span class="hljs-string">"ring-2 ring-indigo-500"</span> : <span class="hljs-string">"hover:bg-slate-50"</span>
      )}
      onClick={onSelect}
      onMouseEnter={<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> onHover(<span class="hljs-literal">true</span>)}
      onMouseLeave={<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> onHover(<span class="hljs-literal">false</span>)}
    &gt;
      &lt;div className=<span class="hljs-string">"font-medium truncate"</span>&gt;{room.title ?? room.id.slice(<span class="hljs-number">0</span>, <span class="hljs-number">12</span>)}&lt;<span class="hljs-regexp">/div&gt;
      
      &lt;div className="flex gap-2 mt-2 text-xs text-slate-600"&gt;
        &lt;span&gt;Args: {room.nArgs}&lt;/</span>span&gt;
        &lt;span&gt;Edges: {room.nEdges}&lt;<span class="hljs-regexp">/span&gt;
      &lt;/</span>div&gt;
      
      &lt;div className=<span class="hljs-string">"mt-2 h-2 bg-slate-200 rounded overflow-hidden"</span>&gt;
        &lt;div 
          className=<span class="hljs-string">"h-full bg-emerald-500"</span> 
          style={{ width: <span class="hljs-string">`<span class="hljs-subst">${acceptShare * <span class="hljs-number">100</span>}</span>%`</span> }}
        /&gt;
      &lt;<span class="hljs-regexp">/div&gt;
      
      {room.tags?.length &amp;&amp; (
        &lt;div className="mt-2 flex flex-wrap gap-1"&gt;
          {room.tags.slice(0, 3).map(t =&gt; (
            &lt;span key={t} className="text-[10px] px-1 py-0.5 rounded bg-slate-100"&gt;
              {t}
            &lt;/</span>span&gt;
          ))}
        &lt;<span class="hljs-regexp">/div&gt;
      )}
    &lt;/</span>div&gt;
  );
}
</div></code></pre>
<h3 id="85-plexusmatrix-adjacency-matrix">8.5 PlexusMatrix (Adjacency Matrix)</h3>
<p><strong>File:</strong> <code>components/agora/PlexusMatrix.tsx</code> (331 lines)</p>
<p>Matrix visualization showing room-to-room relationships.</p>
<h4 id="851-key-features">8.5.1 Key Features</h4>
<ul>
<li><strong>Canvas rendering</strong> - Efficient for large matrices</li>
<li><strong>Edge bundling</strong> - Multiple edge types per cell</li>
<li><strong>Hover details</strong> - Cell tooltip with edge info</li>
<li><strong>Minimap</strong> - Overview for navigation</li>
<li><strong>Scroll sync</strong> - Synchronized row/column headers</li>
</ul>
<h4 id="852-matrix-rendering">8.5.2 Matrix Rendering</h4>
<pre class="hljs"><code><div><span class="hljs-comment">// Build cell data</span>
<span class="hljs-keyword">type</span> Cell = { [K <span class="hljs-keyword">in</span> EdgeKind]?: <span class="hljs-built_in">number</span> };
<span class="hljs-keyword">const</span> bundle = useMemo(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> m = <span class="hljs-keyword">new</span> Map&lt;<span class="hljs-built_in">string</span>, Cell&gt;();
  <span class="hljs-keyword">const</span> key = <span class="hljs-function">(<span class="hljs-params">i: <span class="hljs-built_in">number</span>, j: <span class="hljs-built_in">number</span></span>) =&gt;</span> i &lt;= j ? <span class="hljs-string">`<span class="hljs-subst">${i}</span>|<span class="hljs-subst">${j}</span>`</span> : <span class="hljs-string">`<span class="hljs-subst">${j}</span>|<span class="hljs-subst">${i}</span>`</span>;
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> e of data.edges) {
    <span class="hljs-keyword">const</span> i = idx.get(e.from), j = idx.get(e.to);
    <span class="hljs-keyword">if</span> (i == <span class="hljs-literal">null</span> || j == <span class="hljs-literal">null</span>) <span class="hljs-keyword">continue</span>;
    
    <span class="hljs-keyword">const</span> k = key(i, j);
    <span class="hljs-keyword">const</span> cell = m.get(k) ?? {};
    cell[e.kind] = (cell[e.kind] || <span class="hljs-number">0</span>) + e.weight;
    m.set(k, cell);
  }
  <span class="hljs-keyword">return</span> m;
}, [data.edges, idx]);

<span class="hljs-comment">// Canvas drawing</span>
useEffect(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> ctx = canvasRef.current?.getContext(<span class="hljs-string">'2d'</span>);
  <span class="hljs-keyword">if</span> (!ctx) <span class="hljs-keyword">return</span>;
  
  ctx.clearRect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; N; i++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = i; j &lt; N; j++) {
      <span class="hljs-keyword">const</span> cell = bundle.get(<span class="hljs-string">`<span class="hljs-subst">${i}</span>|<span class="hljs-subst">${j}</span>`</span>);
      <span class="hljs-keyword">if</span> (!cell) <span class="hljs-keyword">continue</span>;
      
      <span class="hljs-comment">// Draw colored segments for each edge type</span>
      <span class="hljs-keyword">let</span> offset = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [kind, weight] of <span class="hljs-built_in">Object</span>.entries(cell)) {
        <span class="hljs-keyword">if</span> (!onKinds[kind <span class="hljs-keyword">as</span> EdgeKind]) <span class="hljs-keyword">continue</span>;
        ctx.fillStyle = KCOL[kind <span class="hljs-keyword">as</span> EdgeKind];
        ctx.fillRect(
          CELL_SIZE * j + offset,
          CELL_SIZE * i,
          <span class="hljs-built_in">Math</span>.ceil(CELL_SIZE * (weight / maxWeight)),
          CELL_SIZE
        );
        offset += <span class="hljs-number">4</span>;
      }
    }
  }
}, [bundle, N, onKinds]);
</div></code></pre>
<h3 id="86-plexusroommetrics">8.6 PlexusRoomMetrics</h3>
<p><strong>File:</strong> <code>components/agora/PlexusRoomMetrics.tsx</code> (~100 lines)</p>
<p>Detailed metrics display for a selected room.</p>
<pre class="hljs"><code><div><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">PlexusRoomMetrics</span>(<span class="hljs-params">{ roomId }: { roomId: <span class="hljs-built_in">string</span> }</span>) </span>{
  <span class="hljs-keyword">const</span> { data } = useSWR(
    roomId ? <span class="hljs-string">`/api/agora/room-metrics?id=<span class="hljs-subst">${roomId}</span>`</span> : <span class="hljs-literal">null</span>,
    fetcher
  );

  <span class="hljs-keyword">if</span> (!data) <span class="hljs-keyword">return</span> &lt;div&gt;Loading...&lt;<span class="hljs-regexp">/div&gt;;

  return (
    &lt;div className="rounded-xl border bg-white/</span><span class="hljs-number">70</span> p<span class="hljs-number">-4</span><span class="hljs-string">"&gt;
      &lt;h3 className="</span>font-semibold<span class="hljs-string">"&gt;{data.title ?? roomId.slice(0, 12)}&lt;/h3&gt;
      
      &lt;div className="</span>grid grid-cols<span class="hljs-number">-2</span> gap<span class="hljs-number">-4</span> mt<span class="hljs-number">-4</span> text-sm<span class="hljs-string">"&gt;
        &lt;div&gt;
          &lt;div className="</span>text-slate<span class="hljs-number">-500</span><span class="hljs-string">"&gt;Arguments&lt;/div&gt;
          &lt;div className="</span>text-xl font-medium<span class="hljs-string">"&gt;{data.nArgs}&lt;/div&gt;
        &lt;/div&gt;
        &lt;div&gt;
          &lt;div className="</span>text-slate<span class="hljs-number">-500</span><span class="hljs-string">"&gt;Edges&lt;/div&gt;
          &lt;div className="</span>text-xl font-medium<span class="hljs-string">"&gt;{data.nEdges}&lt;/div&gt;
        &lt;/div&gt;
        &lt;div&gt;
          &lt;div className="</span>text-slate<span class="hljs-number">-500</span><span class="hljs-string">"&gt;Acceptance Rate&lt;/div&gt;
          &lt;div className="</span>text-xl font-medium text-emerald<span class="hljs-number">-600</span><span class="hljs-string">"&gt;
            {((data.accepted / (data.accepted + data.rejected + data.undecided)) * 100).toFixed(1)}%
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div&gt;
          &lt;div className="</span>text-slate<span class="hljs-number">-500</span><span class="hljs-string">"&gt;Last Updated&lt;/div&gt;
          &lt;div className="</span>text-sm<span class="hljs-string">"&gt;{new Date(data.updatedAt).toLocaleDateString()}&lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;div className="</span>mt<span class="hljs-number">-4</span> flex gap<span class="hljs-number">-2</span><span class="hljs-string">"&gt;
        &lt;a href={`/deliberation/${roomId}`} className="</span>btn<span class="hljs-string">"&gt;Open&lt;/a&gt;
        {data.debateSheetId &amp;&amp; (
          &lt;a href={`/sheet/${data.debateSheetId}`} className="</span>btn-outline<span class="hljs-string">"&gt;Sheet&lt;/a&gt;
        )}
      &lt;/div&gt;
    &lt;/div&gt;
  );
}
</span></div></code></pre>
<h3 id="87-useconfidence-hook">8.7 useConfidence Hook</h3>
<p><strong>File:</strong> <code>components/agora/useConfidence.tsx</code></p>
<p>Context for confidence mode selection across Plexus and debate sheets.</p>
<pre class="hljs"><code><div><span class="hljs-keyword">type</span> ConfidenceMode = <span class="hljs-string">'min'</span> | <span class="hljs-string">'product'</span> | <span class="hljs-string">'ds'</span>;

<span class="hljs-keyword">interface</span> ConfidenceContext {
  mode: ConfidenceMode;
  setMode: <span class="hljs-function">(<span class="hljs-params">m: ConfidenceMode</span>) =&gt;</span> <span class="hljs-built_in">void</span>;
  tau: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span>;      <span class="hljs-comment">// Threshold for DS mode</span>
  setTau: <span class="hljs-function">(<span class="hljs-params">t: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">useConfidence</span>(<span class="hljs-params"></span>): <span class="hljs-title">ConfidenceContext</span> </span>{
  <span class="hljs-comment">// Context implementation with localStorage persistence</span>
}
</div></code></pre>
<h3 id="88-confidencecontrols-component">8.8 ConfidenceControls Component</h3>
<p><strong>File:</strong> <code>components/agora/ConfidenceControls.tsx</code></p>
<p>UI for selecting confidence mode.</p>
<pre class="hljs"><code><div><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ConfidenceControls</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> { mode, setMode, tau, setTau } = useConfidence();

  <span class="hljs-keyword">return</span> (
    &lt;div className=<span class="hljs-string">"flex items-center gap-3 text-sm"</span>&gt;
      &lt;label&gt;Confidence:&lt;<span class="hljs-regexp">/label&gt;
      &lt;select 
        value={mode} 
        onChange={(e) =&gt; setMode(e.target.value as ConfidenceMode)}
        className="border rounded px-2 py-1"
      &gt;
        &lt;option value="product"&gt;Product&lt;/</span>option&gt;
        &lt;option value=<span class="hljs-string">"min"</span>&gt;Min&lt;<span class="hljs-regexp">/option&gt;
        &lt;option value="ds"&gt;Dempster-Shafer&lt;/</span>option&gt;
      &lt;<span class="hljs-regexp">/select&gt;
      
      {mode === 'ds' &amp;&amp; (
        &lt;input
          type="range"
          min="0"
          max="1"
          step="0.05"
          value={tau ?? 0.5}
          onChange={(e) =&gt; setTau(Number(e.target.value))}
          className="w-24"
        /</span>&gt;
      )}
    &lt;<span class="hljs-regexp">/div&gt;
  );
}
</span></div></code></pre>
<hr>
<h2 id="9-following--subscription-system">9. Following &amp; Subscription System</h2>
<h3 id="91-system-architecture">9.1 System Architecture</h3>
<pre class="hljs"><code><div>┌─────────────────────────────────────────────────────────────────────────┐
│                    FOLLOWING SYSTEM ARCHITECTURE                        │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                         Client Layer                                    │
│                                                                         │
│  ┌───────────────────┐  ┌───────────────────┐  ┌───────────────────┐   │
│  │  useFollowing()   │  │useStackFollowing()│  │   EventCard       │   │
│  │                   │  │                   │  │   Follow Buttons  │   │
│  │ • roomSet        │  │ • stackSet        │  │                   │   │
│  │ • tagSet         │  │ • isFollowingStack│  │ • onFollow()     │   │
│  │ • followRoom()   │  │                   │  │ • onUnfollow()   │   │
│  │ • unfollowRoom() │  │                   │  │                   │   │
│  │ • followTag()    │  │                   │  │                   │   │
│  │ • unfollowTag()  │  │                   │  │                   │   │
│  └─────────┬─────────┘  └─────────┬─────────┘  └─────────┬─────────┘   │
│            │                      │                      │             │
│            └──────────────────────┼──────────────────────┘             │
│                                   │                                     │
└───────────────────────────────────┼─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          API Layer                                      │
│                                                                         │
│  ┌───────────────────────────┐    ┌───────────────────────────────┐    │
│  │      /api/follow          │    │   /api/stacks/subscriptions    │    │
│  │                           │    │                               │    │
│  │  GET    → List follows    │    │  GET → List subscribed stacks │    │
│  │  POST   → Follow          │    │                               │    │
│  │  DELETE → Unfollow        │    │                               │    │
│  └─────────────┬─────────────┘    └───────────────┬───────────────┘    │
│                │                                   │                    │
└────────────────┼───────────────────────────────────┼────────────────────┘
                 │                                   │
                 ▼                                   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        Database Layer                                   │
│                                                                         │
│  ┌───────────────────────────┐    ┌───────────────────────────────┐    │
│  │      AgoraFollow          │    │    StackSubscription          │    │
│  │                           │    │                               │    │
│  │  userId + kind + targetId │    │  userId + stackId             │    │
│  │  (composite PK)           │    │  (composite PK)               │    │
│  └───────────────────────────┘    └───────────────────────────────┘    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
</div></code></pre>
<h3 id="92-usefollowing-hook">9.2 useFollowing Hook</h3>
<p><strong>File:</strong> <code>lib/client/useFollowing.ts</code></p>
<p>Primary hook for room and tag following state.</p>
<pre class="hljs"><code><div><span class="hljs-keyword">type</span> Item = {
  userId: <span class="hljs-built_in">string</span>;
  kind: <span class="hljs-string">"room"</span> | <span class="hljs-string">"tag"</span>;
  targetId: <span class="hljs-built_in">string</span>;
  createdAt: <span class="hljs-built_in">string</span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">useFollowing</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> { data, mutate } = useSWR&lt;{ items: Item[] }&gt;(
    <span class="hljs-string">"/api/follow"</span>,
    fetcher,
    { revalidateOnFocus: <span class="hljs-literal">false</span> }
  );

  <span class="hljs-keyword">const</span> items = data?.items ?? [];

  <span class="hljs-comment">// Build lookup sets for O(1) checks</span>
  <span class="hljs-keyword">const</span> roomSet = <span class="hljs-keyword">new</span> Set(
    items.filter(<span class="hljs-function">(<span class="hljs-params">i</span>) =&gt;</span> i.kind === <span class="hljs-string">"room"</span>).map(<span class="hljs-function">(<span class="hljs-params">i</span>) =&gt;</span> i.targetId)
  );
  <span class="hljs-keyword">const</span> tagSet = <span class="hljs-keyword">new</span> Set(
    items.filter(<span class="hljs-function">(<span class="hljs-params">i</span>) =&gt;</span> i.kind === <span class="hljs-string">"tag"</span>).map(<span class="hljs-function">(<span class="hljs-params">i</span>) =&gt;</span> i.targetId.toLowerCase())
  );

  <span class="hljs-comment">// Follow/unfollow mutations</span>
  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">follow</span>(<span class="hljs-params">kind: "room" | "tag", targetId: <span class="hljs-built_in">string</span></span>) </span>{
    <span class="hljs-keyword">await</span> fetch(<span class="hljs-string">"/api/follow"</span>, {
      method: <span class="hljs-string">"POST"</span>,
      headers: { <span class="hljs-string">"content-type"</span>: <span class="hljs-string">"application/json"</span> },
      body: <span class="hljs-built_in">JSON</span>.stringify({ kind, targetId }),
    });
    mutate(); <span class="hljs-comment">// Revalidate</span>
  }

  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unfollow</span>(<span class="hljs-params">kind: "room" | "tag", targetId: <span class="hljs-built_in">string</span></span>) </span>{
    <span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> URLSearchParams({ kind, targetId });
    <span class="hljs-keyword">await</span> fetch(<span class="hljs-string">`/api/follow?<span class="hljs-subst">${p.toString()}</span>`</span>, { method: <span class="hljs-string">"DELETE"</span> });
    mutate();
  }

  <span class="hljs-comment">// Convenience helpers</span>
  <span class="hljs-keyword">const</span> isFollowingRoom = <span class="hljs-function">(<span class="hljs-params">deliberationId?: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span></span>) =&gt;</span>
    !!deliberationId &amp;&amp; roomSet.has(deliberationId);
  
  <span class="hljs-keyword">const</span> isFollowingTag = <span class="hljs-function">(<span class="hljs-params">tag?: <span class="hljs-built_in">string</span></span>) =&gt;</span>
    !!tag &amp;&amp; tagSet.has(tag.toLowerCase());

  <span class="hljs-keyword">const</span> followRoom = <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>) =&gt;</span> follow(<span class="hljs-string">"room"</span>, id);
  <span class="hljs-keyword">const</span> unfollowRoom = <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>) =&gt;</span> unfollow(<span class="hljs-string">"room"</span>, id);
  <span class="hljs-keyword">const</span> followTag = <span class="hljs-function">(<span class="hljs-params">tag: <span class="hljs-built_in">string</span></span>) =&gt;</span> follow(<span class="hljs-string">"tag"</span>, tag);
  <span class="hljs-keyword">const</span> unfollowTag = <span class="hljs-function">(<span class="hljs-params">tag: <span class="hljs-built_in">string</span></span>) =&gt;</span> unfollow(<span class="hljs-string">"tag"</span>, tag);

  <span class="hljs-keyword">return</span> {
    items,
    roomSet,
    tagSet,
    isFollowingRoom,
    isFollowingTag,
    followRoom,
    unfollowRoom,
    followTag,
    unfollowTag,
    mutate,
  };
}
</div></code></pre>
<h3 id="93-usestackfollowing-hook">9.3 useStackFollowing Hook</h3>
<p><strong>File:</strong> <code>lib/client/useStackFollowing.ts</code></p>
<p>Hook for stack subscription state.</p>
<pre class="hljs"><code><div><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">useStackFollowing</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> { data } = useSWR&lt;{ items: <span class="hljs-built_in">string</span>[] }&gt;(
    <span class="hljs-string">"/api/stacks/subscriptions"</span>,
    fetcher,
    { revalidateOnFocus: <span class="hljs-literal">false</span> }
  );

  <span class="hljs-keyword">const</span> <span class="hljs-keyword">set</span> = <span class="hljs-keyword">new</span> Set((data?.items ?? []).map(<span class="hljs-built_in">String</span>));
  
  <span class="hljs-keyword">const</span> isFollowingStack = <span class="hljs-function">(<span class="hljs-params">id?: <span class="hljs-built_in">string</span></span>) =&gt;</span> !!(id &amp;&amp; <span class="hljs-keyword">set</span>.has(id));

  <span class="hljs-keyword">return</span> { stackSet: <span class="hljs-keyword">set</span>, isFollowingStack };
}
</div></code></pre>
<h3 id="94-integration-with-feed-filtering">9.4 Integration with Feed Filtering</h3>
<p>The following system integrates with the Agora feed to filter events:</p>
<pre class="hljs"><code><div><span class="hljs-comment">// In Agora.tsx</span>
<span class="hljs-keyword">const</span> filtered = useMemo(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  <span class="hljs-keyword">if</span> (tab !== <span class="hljs-string">"following"</span>) <span class="hljs-keyword">return</span> events;
  <span class="hljs-keyword">if</span> (!hasFollowData) <span class="hljs-keyword">return</span> events; <span class="hljs-comment">// Show all if no data yet</span>

  <span class="hljs-keyword">return</span> events.filter(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-comment">// Check room following</span>
    <span class="hljs-keyword">const</span> inRooms = e.deliberationId ? roomSet.has(e.deliberationId) : <span class="hljs-literal">false</span>;
    
    <span class="hljs-comment">// Check tag following</span>
    <span class="hljs-keyword">const</span> inTags = <span class="hljs-function">(<span class="hljs-params">e.chips || []</span>).<span class="hljs-params">some</span>(<span class="hljs-params">(<span class="hljs-params">c</span>) =&gt; isFollowingTag(<span class="hljs-params">c</span>)</span>);
    
    // <span class="hljs-params">Check</span> <span class="hljs-params">stack</span> <span class="hljs-params">following</span> <span class="hljs-params">for</span> <span class="hljs-params">stack</span> <span class="hljs-params">events</span>
    <span class="hljs-params">const</span> <span class="hljs-params">inStacks</span> =
      (<span class="hljs-params">e.<span class="hljs-keyword">type</span> === "stacks:changed" || e.<span class="hljs-keyword">type</span> === "comments:changed"</span>) &amp;&amp;
      (<span class="hljs-params">e <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span></span>).<span class="hljs-params">link</span>?.<span class="hljs-params">includes</span>(<span class="hljs-params">"/stacks/"</span>)
        ? <span class="hljs-params">isFollowingStack</span>(<span class="hljs-params">(<span class="hljs-params">e <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span></span>).link.split(<span class="hljs-params">"/stacks/"</span>)[1]</span>)
        : <span class="hljs-params">false</span>;

    // <span class="hljs-params">Check</span> <span class="hljs-params">citations</span> <span class="hljs-params">linked</span> <span class="hljs-params">to</span> <span class="hljs-params">followed</span> <span class="hljs-params">rooms</span>/<span class="hljs-params">stacks</span>
    <span class="hljs-params">const</span> <span class="hljs-params">cit</span> = <span class="hljs-params">e</span>.<span class="hljs-params">type</span> === "<span class="hljs-params">citations</span>:<span class="hljs-params">changed</span>" ? (<span class="hljs-params">e <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span></span>) : <span class="hljs-params">null</span>;
    <span class="hljs-params">const</span> <span class="hljs-params">citInRoom</span> = <span class="hljs-params">cit</span>?.<span class="hljs-params">deliberationId</span> ? <span class="hljs-params">roomSet</span>.<span class="hljs-params">has</span>(<span class="hljs-params">cit.deliberationId</span>) : <span class="hljs-params">false</span>;
    <span class="hljs-params">const</span> <span class="hljs-params">citInStack</span> = <span class="hljs-params">cit</span>?.<span class="hljs-params">contextLink</span>?.<span class="hljs-params">includes</span>(<span class="hljs-params">"/stacks/"</span>)
      ? <span class="hljs-params">isFollowingStack</span>(<span class="hljs-params">cit.contextLink.split(<span class="hljs-params">"/stacks/"</span>)[1].split(<span class="hljs-params">"#"</span>)[0]</span>)
      : <span class="hljs-params">false</span>;

    <span class="hljs-params">return</span> <span class="hljs-params">inRooms</span> || <span class="hljs-params">inTags</span> || <span class="hljs-params">inStacks</span> || <span class="hljs-params">citInRoom</span> || <span class="hljs-params">citInStack</span>;
  });
}, [<span class="hljs-params">events</span>, <span class="hljs-params">tab</span>, <span class="hljs-params">roomSet</span>, <span class="hljs-params">isFollowingTag</span>, <span class="hljs-params">isFollowingStack</span>, <span class="hljs-params">hasFollowData</span>]);
</span></div></code></pre>
<h3 id="95-follow-event-propagation">9.5 Follow Event Propagation</h3>
<p>When follow state changes, dispatch custom event for cross-component sync:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doFollow</span>(<span class="hljs-params">roomId: <span class="hljs-built_in">string</span></span>) </span>{
  setPendingOn(roomId, <span class="hljs-literal">true</span>);
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> followRoom(roomId);
    flashOk(roomId);
    
    <span class="hljs-comment">// Broadcast to other components</span>
    <span class="hljs-built_in">window</span>.dispatchEvent(
      <span class="hljs-keyword">new</span> CustomEvent(<span class="hljs-string">"follow:changed"</span>, {
        detail: { kind: <span class="hljs-string">"room"</span>, id: roomId, following: <span class="hljs-literal">true</span> },
      })
    );
  } <span class="hljs-keyword">finally</span> {
    setPendingOn(roomId, <span class="hljs-literal">false</span>);
  }
}
</div></code></pre>
<hr>
<h2 id="10-deliberation-integration">10. Deliberation Integration</h2>
<h3 id="101-integration-overview">10.1 Integration Overview</h3>
<p>The Agora system serves as the discovery and navigation layer for the Mesh deliberation infrastructure. It provides multiple entry points into deliberations and maintains bidirectional connections with the argumentation system.</p>
<pre class="hljs"><code><div>┌─────────────────────────────────────────────────────────────────────────┐
│                  AGORA ↔ DELIBERATION INTEGRATION                       │
└─────────────────────────────────────────────────────────────────────────┘

                         ┌─────────────────────┐
                         │     AGORA FEED      │
                         │                     │
                         │  • Event Discovery  │
                         │  • Following        │
                         │  • Plexus Nav       │
                         └──────────┬──────────┘
                                    │
              ┌─────────────────────┼─────────────────────┐
              │                     │                     │
              ▼                     ▼                     ▼
     ┌────────────────┐   ┌────────────────┐   ┌────────────────┐
     │  Feed Events   │   │  Debates View  │   │  Plexus View   │
     │                │   │                │   │                │
     │ dialogue:*     │   │ DebateSheet    │   │ Room Network   │
     │ citations:*    │   │ Reader         │   │ Visualization  │
     │ decision:*     │   │                │   │                │
     └───────┬────────┘   └───────┬────────┘   └───────┬────────┘
             │                    │                    │
             └────────────────────┼────────────────────┘
                                  │
                                  ▼
              ┌─────────────────────────────────────────┐
              │           DELIBERATION SYSTEM           │
              │                                         │
              │  ┌─────────────┐  ┌─────────────┐      │
              │  │ Arguments   │  │  Claims     │      │
              │  │ Schemes     │  │  Evidence   │      │
              │  │ Chains      │  │  Decisions  │      │
              │  └─────────────┘  └─────────────┘      │
              │                                         │
              │  ┌─────────────┐  ┌─────────────┐      │
              │  │ Dialogue    │  │  ASPIC+     │      │
              │  │ Moves       │  │  Semantics  │      │
              │  └─────────────┘  └─────────────┘      │
              └─────────────────────────────────────────┘
</div></code></pre>
<h3 id="102-event-integration-points">10.2 Event Integration Points</h3>
<h4 id="1021-dialogue-events">10.2.1 Dialogue Events</h4>
<p>When dialogue moves are created, events flow to Agora:</p>
<pre class="hljs"><code><div><span class="hljs-comment">// In dialogue move creation API</span>
<span class="hljs-keyword">import</span> { emitBus } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/lib/server/bus"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">POST</span>(<span class="hljs-params">req: NextRequest</span>) </span>{
  <span class="hljs-keyword">const</span> move = <span class="hljs-keyword">await</span> prisma.dialogueMove.create({
    data: { ... }
  });

  <span class="hljs-comment">// Emit event for Agora consumption</span>
  emitBus(<span class="hljs-string">"dialogue:moves:refresh"</span>, {
    deliberationId: move.deliberationId,
    moveId: move.id,
    kind: move.kind,
  });

  <span class="hljs-keyword">return</span> NextResponse.json({ ok: <span class="hljs-literal">true</span>, move });
}
</div></code></pre>
<p><strong>Event Mapping in Agora.tsx:</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">case</span> <span class="hljs-string">"dialogue:moves:refresh"</span>:
  ev = {
    id: <span class="hljs-string">`mv:<span class="hljs-subst">${m.moveId || ts}</span>`</span>,
    <span class="hljs-keyword">type</span>: <span class="hljs-string">"dialogue:changed"</span>,
    ts,
    title: <span class="hljs-string">`New move<span class="hljs-subst">${m.kind ? <span class="hljs-string">` (<span class="hljs-subst">${m.kind}</span>)`</span> : <span class="hljs-string">""</span>}</span>`</span>,
    meta: m.deliberationId ? <span class="hljs-string">`room:<span class="hljs-subst">${m.deliberationId.slice(<span class="hljs-number">0</span>, <span class="hljs-number">6</span>)}</span>…`</span> : <span class="hljs-literal">undefined</span>,
    chips: m.kind ? [m.kind] : [],
    link: m.deliberationId ? <span class="hljs-string">`/deliberation/<span class="hljs-subst">${m.deliberationId}</span>`</span> : <span class="hljs-literal">undefined</span>,
    deliberationId: m.deliberationId,
    icon: <span class="hljs-string">"move"</span>,
  };
  <span class="hljs-keyword">break</span>;
</div></code></pre>
<h4 id="1022-citation-events">10.2.2 Citation Events</h4>
<p>When citations are added to claims or comments:</p>
<pre class="hljs"><code><div><span class="hljs-comment">// In citation creation API</span>
emitBus(<span class="hljs-string">"citations:changed"</span>, {
  targetType: citation.targetType,     <span class="hljs-comment">// "claim" | "comment"</span>
  targetId: citation.targetId,
  sourceId: citation.sourceId,
  url: source.url,
  quote: citation.quote,
  note: citation.note,
  deliberationId: derivedDelibId,
});
</div></code></pre>
<p><strong>Event Mapping:</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">case</span> <span class="hljs-string">"citations:changed"</span>: {
  <span class="hljs-keyword">const</span> titleTxt = niceTitle(m);
  <span class="hljs-keyword">const</span> targetLabel = m.targetType === <span class="hljs-string">"comment"</span> ? <span class="hljs-string">"Comment"</span>
    : m.targetType === <span class="hljs-string">"claim"</span> ? <span class="hljs-string">"Claim"</span> : m.targetType || <span class="hljs-string">"Target"</span>;

  ev = {
    id: <span class="hljs-string">`ct:<span class="hljs-subst">${ts}</span>:<span class="hljs-subst">${m.sourceId || <span class="hljs-string">""</span>}</span>:<span class="hljs-subst">${m.targetId || <span class="hljs-string">""</span>}</span>`</span>,
    <span class="hljs-keyword">type</span>: <span class="hljs-string">"citations:changed"</span>,
    ts,
    title: <span class="hljs-string">`Added source: <span class="hljs-subst">${titleTxt}</span>`</span>,
    meta: <span class="hljs-string">`<span class="hljs-subst">${targetLabel}</span><span class="hljs-subst">${domainLabel}</span><span class="hljs-subst">${preview}</span>`</span>,
    chips: [quoteChip, noteChip, kindChip].filter(<span class="hljs-built_in">Boolean</span>),
    link: m.url || contextLink,
    contextLink,
    icon: <span class="hljs-string">"link"</span>,
    deliberationId: m.deliberationId,
  };
  <span class="hljs-keyword">break</span>;
}
</div></code></pre>
<h4 id="1023-decision-events">10.2.3 Decision Events</h4>
<p>When claims are accepted or rejected:</p>
<pre class="hljs"><code><div><span class="hljs-comment">// In decision recording API</span>
emitBus(<span class="hljs-string">"decision:changed"</span>, {
  deliberationId: decision.deliberationId,
  kind: decision.kind,        <span class="hljs-comment">// "accept" | "reject" | "defer"</span>
  rationale: decision.rationale,
});
</div></code></pre>
<p><strong>Event Mapping:</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">case</span> <span class="hljs-string">"decision:changed"</span>:
  ev = {
    id: <span class="hljs-string">`dc:<span class="hljs-subst">${ts}</span>`</span>,
    <span class="hljs-keyword">type</span>: <span class="hljs-string">"decision:changed"</span>,
    ts,
    title: <span class="hljs-string">"Decision recorded"</span>,
    meta: m.rationale || <span class="hljs-string">""</span>,
    chips: [m.kind || <span class="hljs-string">"decision"</span>],
    link: m.deliberationId ? <span class="hljs-string">`/deliberation/<span class="hljs-subst">${m.deliberationId}</span>`</span> : <span class="hljs-literal">undefined</span>,
    deliberationId: m.deliberationId,
    icon: <span class="hljs-string">"check"</span>,
  };
  <span class="hljs-keyword">break</span>;
</div></code></pre>
<h3 id="103-debates-view">10.3 Debates View</h3>
<p>The Debates view provides direct navigation into the deliberation system:</p>
<h4 id="1031-picker-hierarchy">10.3.1 Picker Hierarchy</h4>
<pre class="hljs"><code><div>RoomPicker → DebatePicker → SheetPicker → DebateSheetReader
    │             │              │
    ▼             ▼              ▼
/api/agora/   /api/agora/    /api/sheets/
rooms         rooms/[id]/    by-deliberation/
              deliberations  [id]
</div></code></pre>
<h4 id="1032-roompicker-component">10.3.2 RoomPicker Component</h4>
<p><strong>File:</strong> <code>components/agora/RoomAndDebatePickers.tsx</code></p>
<pre class="hljs"><code><div><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RoomPicker</span>(<span class="hljs-params">{
  value,
  onChange,
}: {
  value: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>;
  onChange: (id: <span class="hljs-built_in">string</span>) =&gt; <span class="hljs-built_in">void</span>;
}</span>) </span>{
  <span class="hljs-keyword">const</span> { data } = useSWR(<span class="hljs-string">'/api/agora/rooms'</span>, fetcher);
  <span class="hljs-keyword">const</span> rooms = data?.items ?? [];

  <span class="hljs-keyword">return</span> (
    &lt;div className=<span class="hljs-string">"flex items-center gap-2 text-sm"</span>&gt;
      &lt;label&gt;Room:&lt;<span class="hljs-regexp">/label&gt;
      &lt;select
        className="menuv2--lite rounded px-2 py-1"
        value={value ?? ''}
        onChange={(e) =&gt; onChange(e.target.value)}
      &gt;
        {!value &amp;&amp; &lt;option value=""&gt;Select…&lt;/</span>option&gt;}
        {rooms.map(<span class="hljs-function">(<span class="hljs-params">r: <span class="hljs-built_in">any</span></span>) =&gt;</span> (
          &lt;option key={r.id} value={r.id}&gt;
            {r.title ?? r.slug}
          &lt;<span class="hljs-regexp">/option&gt;
        ))}
      &lt;/</span>select&gt;
    &lt;<span class="hljs-regexp">/div&gt;
  );
}
</span></div></code></pre>
<h4 id="1033-debatepicker-component">10.3.3 DebatePicker Component</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">DebatePicker</span>(<span class="hljs-params">{
  roomId,
  value,
  onChange,
}: {
  roomId?: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>;
  value: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>;
  onChange: (id: <span class="hljs-built_in">string</span>) =&gt; <span class="hljs-built_in">void</span>;
}</span>) </span>{
  <span class="hljs-keyword">const</span> { data } = useSWR(
    roomId ? <span class="hljs-string">`/api/agora/rooms/<span class="hljs-subst">${roomId}</span>/deliberations`</span> : <span class="hljs-literal">null</span>,
    fetcher
  );
  <span class="hljs-keyword">const</span> debates = data?.items ?? [];

  <span class="hljs-keyword">if</span> (!roomId) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> (
    &lt;div className=<span class="hljs-string">"flex items-center gap-2 text-sm"</span>&gt;
      &lt;label&gt;Debate:&lt;<span class="hljs-regexp">/label&gt;
      &lt;select
        className="menuv2--lite w-full rounded px-2 py-1"
        value={value ?? ''}
        onChange={(e) =&gt; onChange(e.target.value)}
      &gt;
        {!value &amp;&amp; &lt;option value=""&gt;Select…&lt;/</span>option&gt;}
        {debates.map(<span class="hljs-function">(<span class="hljs-params">d: <span class="hljs-built_in">any</span></span>) =&gt;</span> (
          &lt;option key={d.id} value={d.id}&gt;
            {d.title}
          &lt;<span class="hljs-regexp">/option&gt;
        ))}
      &lt;/</span>select&gt;
    &lt;<span class="hljs-regexp">/div&gt;
  );
}
</span></div></code></pre>
<h4 id="1034-sheetpicker-component">10.3.4 SheetPicker Component</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SheetPicker</span>(<span class="hljs-params">{
  deliberationId,
  value,
  onChange,
}: {
  deliberationId?: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>;
  value: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>;
  onChange: (id: <span class="hljs-built_in">string</span>) =&gt; <span class="hljs-built_in">void</span>;
}</span>) </span>{
  <span class="hljs-keyword">const</span> { data } = useSWR(
    deliberationId ? <span class="hljs-string">`/api/sheets/by-deliberation/<span class="hljs-subst">${deliberationId}</span>`</span> : <span class="hljs-literal">null</span>,
    fetcher
  );
  <span class="hljs-keyword">const</span> curated = data?.items ?? [];

  <span class="hljs-keyword">if</span> (!deliberationId) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> (
    &lt;div className=<span class="hljs-string">"flex items-center gap-2 text-sm"</span>&gt;
      &lt;label&gt;Sheet:&lt;<span class="hljs-regexp">/label&gt;
      &lt;select
        className="menuv2--lite rounded px-2 py-1"
        value={value ?? `delib:${deliberationId}`}
        onChange={(e) =&gt; onChange(e.target.value)}
      &gt;
        {/</span>* Synthetic sheet <span class="hljs-keyword">from</span> live deliberation *<span class="hljs-regexp">/}
        &lt;option value={`delib:${deliberationId}`}&gt;Live (synthetic)&lt;/</span>option&gt;
        
        {<span class="hljs-comment">/* Curated sheets */</span>}
        {curated.map(<span class="hljs-function">(<span class="hljs-params">s: <span class="hljs-built_in">any</span></span>) =&gt;</span> (
          &lt;option key={s.id} value={s.id}&gt;
            {s.title ?? s.id.slice(<span class="hljs-number">0</span>, <span class="hljs-number">18</span>) + <span class="hljs-string">'…'</span>}
          &lt;<span class="hljs-regexp">/option&gt;
        ))}
      &lt;/</span>select&gt;
    &lt;<span class="hljs-regexp">/div&gt;
  );
}
</span></div></code></pre>
<h3 id="104-debatesheetreader-integration">10.4 DebateSheetReader Integration</h3>
<p><strong>File:</strong> <code>components/agora/DebateSheetReader.tsx</code> (533 lines)</p>
<p>The DebateSheetReader provides a spreadsheet-like view of arguments within a deliberation.</p>
<h4 id="1041-data-flow">10.4.1 Data Flow</h4>
<pre class="hljs"><code><div>                    DebateSheetReader
                          │
          ┌───────────────┼───────────────┐
          │               │               │
          ▼               ▼               ▼
   /api/deliberations   useConfidence   useAuth
   /[id]/arguments/full  (mode, tau)    (userId)
          │
          ▼
   ┌─────────────────────────────────────────┐
   │         Unified Argument Data           │
   │                                         │
   │  • id, text, kind                       │
   │  • aif: { nodes, edges, schemes }       │
   │  • support: scalar or DS interval       │
   │  • premises, conclusions                │
   └────────────────────────┬────────────────┘
                            │
              ┌─────────────┼─────────────┐
              │             │             │
              ▼             ▼             ▼
       DebateSheet    ArgumentNetwork   SupportBar
       Header/Filters      Card
</div></code></pre>
<h4 id="1042-props-interface">10.4.2 Props Interface</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">DebateSheetReader</span>(<span class="hljs-params">{ 
  sheetId,           <span class="hljs-comment">// Legacy: "delib:xxx" or sheet ID</span>
  deliberationId     <span class="hljs-comment">// New: direct deliberation ID</span>
}: { 
  sheetId?: <span class="hljs-built_in">string</span>; 
  deliberationId?: <span class="hljs-built_in">string</span>;
}</span>) </span>{
  <span class="hljs-comment">// Extract deliberationId from sheetId if needed</span>
  <span class="hljs-keyword">const</span> delibId = useMemo(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (deliberationId) <span class="hljs-keyword">return</span> deliberationId;
    <span class="hljs-keyword">if</span> (sheetId?.startsWith(<span class="hljs-string">"delib:"</span>)) <span class="hljs-keyword">return</span> sheetId.slice(<span class="hljs-string">"delib:"</span>.length);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }, [deliberationId, sheetId]);
  
  <span class="hljs-comment">// ...</span>
}
</div></code></pre>
<h4 id="1043-unified-data-fetch">10.4.3 Unified Data Fetch</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">const</span> { data: fullData, mutate: refetchData } = useSWR(
  delibId 
    ? <span class="hljs-string">`/api/deliberations/<span class="hljs-subst">${delibId}</span>/arguments/full?limit=500&amp;mode=<span class="hljs-subst">${mode}</span>&amp;imports=<span class="hljs-subst">${imports}</span>`</span> 
    : <span class="hljs-literal">null</span>,
  <span class="hljs-function">(<span class="hljs-params">u: <span class="hljs-built_in">string</span></span>) =&gt;</span> fetch(u, { cache: <span class="hljs-string">'no-store'</span> }).then(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.json()),
  { revalidateOnFocus: <span class="hljs-literal">false</span> }
);

<span class="hljs-comment">// Build lookup maps</span>
<span class="hljs-keyword">const</span> argumentById = useMemo(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> m = <span class="hljs-keyword">new</span> Map&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;();
  <span class="hljs-keyword">if</span> (fullData?.items) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item of fullData.items) {
      m.set(item.id, item);
    }
  }
  <span class="hljs-keyword">return</span> m;
}, [fullData]);
</div></code></pre>
<h4 id="1044-confidence-mode-integration">10.4.4 Confidence Mode Integration</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">const</span> { mode, setMode } = useConfidence();
<span class="hljs-keyword">const</span> [imports, setImports] = useState&lt;<span class="hljs-string">'off'</span> | <span class="hljs-string">'materialized'</span> | <span class="hljs-string">'virtual'</span> | <span class="hljs-string">'all'</span>&gt;(<span class="hljs-string">'off'</span>);

<span class="hljs-comment">// Mode affects how support values are computed</span>
<span class="hljs-comment">// - 'product': Multiply path probabilities</span>
<span class="hljs-comment">// - 'min': Take minimum along path</span>
<span class="hljs-comment">// - 'ds': Dempster-Shafer intervals [bel, pl]</span>
</div></code></pre>
<h3 id="105-hub-component">10.5 Hub Component</h3>
<p><strong>File:</strong> <code>app/hub/ui/Hub.tsx</code></p>
<p>Deliberations discovery dashboard accessible from Agora.</p>
<pre class="hljs"><code><div><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Hub</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> [q, setQ] = useState(<span class="hljs-string">""</span>);
  <span class="hljs-keyword">const</span> [tags, setTags] = useState&lt;<span class="hljs-built_in">string</span>[]&gt;([]);
  <span class="hljs-keyword">const</span> [calls, setCalls] = useState&lt;<span class="hljs-string">"any"</span> | <span class="hljs-string">"open"</span>&gt;(<span class="hljs-string">"any"</span>);

  <span class="hljs-keyword">const</span> params = <span class="hljs-keyword">new</span> URLSearchParams({ q, calls, tags: tags.join(<span class="hljs-string">","</span>) });
  <span class="hljs-keyword">const</span> key = <span class="hljs-string">`/api/hub/deliberations?<span class="hljs-subst">${params.toString()}</span>`</span>;
  <span class="hljs-keyword">const</span> { data, mutate } = useSWR(key, fetcher);

  <span class="hljs-comment">// Live refresh on relevant events</span>
  useBusMutate(
    [
      <span class="hljs-string">"deliberations:created"</span>,
      <span class="hljs-string">"decision:changed"</span>,
      <span class="hljs-string">"votes:changed"</span>,
      <span class="hljs-string">"dialogue:changed"</span>,
      <span class="hljs-string">"comments:changed"</span>,
      <span class="hljs-string">"xref:changed"</span>
    ],
    key,
    <span class="hljs-literal">undefined</span>,
    <span class="hljs-number">150</span>
  );

  <span class="hljs-keyword">const</span> items = data?.items ?? [];

  <span class="hljs-keyword">return</span> (
    &lt;div className=<span class="hljs-string">"max-w-6xl mx-auto p-4 space-y-4"</span>&gt;
      {<span class="hljs-comment">/* Search and filters */</span>}
      &lt;div className=<span class="hljs-string">"flex gap-2 items-center"</span>&gt;
        &lt;input placeholder=<span class="hljs-string">"Search…"</span> value={q} onChange={<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> setQ(e.target.value)} /&gt;
        &lt;select value={calls} onChange={<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> setCalls(e.target.value <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>)}&gt;
          &lt;option value=<span class="hljs-string">"any"</span>&gt;All deliberations&lt;<span class="hljs-regexp">/option&gt;
          &lt;option value="open"&gt;Open calls for input&lt;/</span>option&gt;
        &lt;<span class="hljs-regexp">/select&gt;
      &lt;/</span>div&gt;

      {<span class="hljs-comment">/* Deliberation cards */</span>}
      &lt;div className=<span class="hljs-string">"grid md:grid-cols-2 gap-3"</span>&gt;
        {items.map(<span class="hljs-function">(<span class="hljs-params">d: <span class="hljs-built_in">any</span></span>) =&gt;</span> (
          &lt;DeliberationCard key={d.id} deliberation={d} /&gt;
        ))}
      &lt;<span class="hljs-regexp">/div&gt;
    &lt;/</span>div&gt;
  );
}
</div></code></pre>
<h3 id="106-delibsdashboard-component">10.6 DelibsDashboard Component</h3>
<p><strong>File:</strong> <code>app/(root)/(standard)/profile/deliberations/ui/DelibsDashboard.tsx</code></p>
<p>User's personal deliberations management with Agora integration.</p>
<pre class="hljs"><code><div><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">DelibsDashboard</span>(<span class="hljs-params">{ initialItems }: { initialItems: Item[] }</span>) </span>{
  <span class="hljs-keyword">const</span> router = useRouter();
  <span class="hljs-keyword">const</span> { isFollowingRoom, followRoom, unfollowRoom } = useFollowing();

  <span class="hljs-keyword">return</span> (
    &lt;div className=<span class="hljs-string">"mx-auto max-w-5xl p-4 space-y-6"</span>&gt;
      {<span class="hljs-comment">/* Header with Agora link */</span>}
      &lt;div className=<span class="hljs-string">"flex items-center justify-between"</span>&gt;
        &lt;div className=<span class="hljs-string">"text-[1.8rem] font-semibold"</span>&gt;Your Deliberations&lt;<span class="hljs-regexp">/div&gt;
        &lt;button
          onClick={() =&gt; router.push("/</span>agora<span class="hljs-string">")}
          className="</span>px<span class="hljs-number">-3</span> py<span class="hljs-number">-1.5</span> rounded-xl bg-amber<span class="hljs-number">-300</span> text-black text-sm<span class="hljs-string">"
        &gt;
          Open Agora
        &lt;/button&gt;
      &lt;/div&gt;

      {/* Deliberation table with follow actions */}
      &lt;table&gt;
        &lt;tbody&gt;
          {items.map((i) =&gt; (
            &lt;tr key={i.id}&gt;
              &lt;td&gt;{i.title || i.id}&lt;/td&gt;
              &lt;td&gt;
                {isFollowingRoom(i.id) ? (
                  &lt;button onClick={() =&gt; unfollowRoom(i.id)}&gt;Following ✓&lt;/button&gt;
                ) : (
                  &lt;button onClick={() =&gt; followRoom(i.id)}&gt;Follow&lt;/button&gt;
                )}
              &lt;/td&gt;
            &lt;/tr&gt;
          ))}
        &lt;/tbody&gt;
      &lt;/table&gt;
    &lt;/div&gt;
  );
}
</span></div></code></pre>
<h3 id="107-cross-room-navigation-xref">10.7 Cross-Room Navigation (XRef)</h3>
<p>The Agora RightRail displays backlinks between deliberations:</p>
<pre class="hljs"><code><div><span class="hljs-comment">// In RightRail.tsx</span>
<span class="hljs-keyword">const</span> { data } = useSWR(
  toDelib 
    ? <span class="hljs-string">`/api/xref?toType=deliberation&amp;toId=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(toDelib)}</span>`</span> 
    : <span class="hljs-literal">null</span>,
  fetcher,
  { revalidateOnFocus: <span class="hljs-literal">false</span> }
);
<span class="hljs-keyword">const</span> backlinks = data?.items ?? [];

<span class="hljs-comment">// Render backlinks</span>
{backlinks.map(<span class="hljs-function">(<span class="hljs-params">x: <span class="hljs-built_in">any</span></span>) =&gt;</span> (
  &lt;li key={x.id} className=<span class="hljs-string">"flex items-center justify-between gap-2"</span>&gt;
    &lt;span&gt;{x.relation} <span class="hljs-keyword">from</span> {x.fromType}:{x.fromId.slice(<span class="hljs-number">0</span>, <span class="hljs-number">6</span>)}…&lt;<span class="hljs-regexp">/span&gt;
    {x.fromType === 'deliberation' &amp;&amp; (
      &lt;a href={`/</span>deliberation/${x.fromId}<span class="hljs-string">`}&gt;Open&lt;/a&gt;
    )}
  &lt;/li&gt;
))}
</span></div></code></pre>
<hr>
<h2 id="11-performance--scalability">11. Performance &amp; Scalability</h2>
<h3 id="111-current-architecture-characteristics">11.1 Current Architecture Characteristics</h3>
<h4 id="1111-in-memory-event-storage">11.1.1 In-Memory Event Storage</h4>
<pre class="hljs"><code><div>┌─────────────────────────────────────────────────────────────────────────┐
│                    CURRENT STATE (In-Memory)                            │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                      Server Process                                     │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────── ─┐   │
│  │  globalThis.__agoraRing__                                        │   │
│  │                                                                  │   │
│  │  Ring Buffer (2048 events)                                       │   │
│  │  ┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐               │   │
│  │  │ E1  │ E2  │ E3  │ ... │E2046│E2047│E2048│     │               │   │
│  │  └─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘               │   │
│  │                                               ▲                  │   │
│  │                                               │                  │   │
│  │                                          New events              │   │
│  │                                          push here               │   │
│  └───────────────────────────────────────────────────────────────── ┘   │
│                                                                         │
│  Limitations:                                                           │
│  • Lost on server restart                                               │
│  • No persistence across instances                                      │
│  • Fixed capacity (2048)                                                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
</div></code></pre>
<h4 id="1112-connection-limits">11.1.2 Connection Limits</h4>
<pre class="hljs"><code><div>EventEmitter.defaultMaxListeners = 50

→ Maximum ~50 concurrent SSE connections per process
→ Each connection = one browser tab
→ Horizontal scaling requires shared state
</div></code></pre>
<h3 id="112-client-side-optimizations">11.2 Client-Side Optimizations</h3>
<h4 id="1121-event-coalescing">11.2.1 Event Coalescing</h4>
<p>Reduces UI noise by bundling similar events:</p>
<pre class="hljs"><code><div><span class="hljs-comment">// Without coalescing: 10 dialogue moves = 10 cards</span>
<span class="hljs-comment">// With coalescing: 10 dialogue moves in 3 min = 1 bundle card</span>

<span class="hljs-keyword">const</span> BUNDLE_WINDOW_MS = <span class="hljs-number">3</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>;  <span class="hljs-comment">// 3 minute window</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">coalesce</span>(<span class="hljs-params">prev: AgoraEvent[], ev: AgoraEvent</span>): <span class="hljs-title">AgoraEvent</span>[] </span>{
  <span class="hljs-comment">// Find existing bundle for same room within window</span>
  <span class="hljs-keyword">const</span> i = prev.findIndex(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span>
    e.type === <span class="hljs-string">'bundle'</span> &amp;&amp;
    e.deliberationId === ev.deliberationId &amp;&amp;
    ev.ts - e.ts &lt;= BUNDLE_WINDOW_MS
  );

  <span class="hljs-keyword">if</span> (i &gt;= <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// Update existing bundle</span>
    <span class="hljs-keyword">const</span> b = prev[i];
    <span class="hljs-keyword">const</span> kinds = { ...b.kinds };
    kinds[ev.chips?.[<span class="hljs-number">0</span>] || <span class="hljs-string">'MOVE'</span>] = (kinds[ev.chips?.[<span class="hljs-number">0</span>] || <span class="hljs-string">'MOVE'</span>] || <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> upd = { ...b, ts: ev.ts, kinds };
    <span class="hljs-keyword">return</span> [upd, ...prev.filter(<span class="hljs-function">(<span class="hljs-params">_, idx</span>) =&gt;</span> idx !== i)];
  }

  <span class="hljs-comment">// No bundle, add new event</span>
  <span class="hljs-keyword">return</span> [ev, ...prev];
}
</div></code></pre>
<h4 id="1122-feed-capping">11.2.2 Feed Capping</h4>
<pre class="hljs"><code><div><span class="hljs-comment">// In Agora.tsx useBusEffect handler</span>
<span class="hljs-keyword">if</span> (ev) setEvents(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> coalesce(prev, ev).slice(<span class="hljs-number">0</span>, <span class="hljs-number">200</span>));
<span class="hljs-comment">//                                             ^^^^^^^^^^^^^^</span>
<span class="hljs-comment">//                                             Cap at 200 events</span>

<span class="hljs-comment">// In LiveEventsProvider coalesce</span>
<span class="hljs-keyword">return</span> [ev, ...prev].slice(<span class="hljs-number">0</span>, FEED_CAP);
<span class="hljs-comment">//                          ^^^^^^^^</span>
<span class="hljs-comment">//                          FEED_CAP = 300</span>
</div></code></pre>
<h4 id="1123-swr-caching">11.2.3 SWR Caching</h4>
<pre class="hljs"><code><div><span class="hljs-comment">// Data fetching with SWR caching and deduplication</span>
<span class="hljs-keyword">const</span> { data } = useSWR(
  <span class="hljs-string">`/api/agora/network?scope=<span class="hljs-subst">${scope}</span>`</span>,
  fetcher,
  { revalidateOnFocus: <span class="hljs-literal">false</span> }  <span class="hljs-comment">// Don't refetch on tab focus</span>
);

<span class="hljs-comment">// Targeted revalidation via KEYMAP</span>
<span class="hljs-keyword">const</span> keys = <span class="hljs-keyword">new</span> Set(KEYMAP[ev.type]?.(ev) ?? []);
<span class="hljs-keyword">if</span> (keys.size) {
  queueMicrotask(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> k of keys) swrMutate(k, <span class="hljs-literal">undefined</span>, { revalidate: <span class="hljs-literal">true</span> });
  });
}
</div></code></pre>
<h3 id="113-safety-backfill-mechanism">11.3 Safety Backfill Mechanism</h3>
<p>Handles edge cases of missed events:</p>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">useSafetyBackfill</span>(<span class="hljs-params">onEvent: (e: AnyEvent) =&gt; <span class="hljs-built_in">void</span></span>) </span>{
  useEffect(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> kick = <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-comment">// Fetch events since last known timestamp</span>
      <span class="hljs-keyword">const</span> url = lastTsRef.current
        ? <span class="hljs-string">`/api/agora/events?since=<span class="hljs-subst">${lastTsRef.current}</span>`</span>
        : <span class="hljs-string">`/api/agora/events?limit=0`</span>;
      <span class="hljs-comment">// ...</span>
    };

    <span class="hljs-comment">// Trigger backfill on:</span>
    <span class="hljs-comment">// 1. Tab becomes visible (visibilitychange)</span>
    <span class="hljs-comment">// 2. Network comes back online</span>
    <span class="hljs-comment">// 3. Every 60 seconds (safety net)</span>

    <span class="hljs-keyword">const</span> id = setInterval(kick, <span class="hljs-number">60</span>_000);
    <span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">'visibilitychange'</span>, onVis);
    <span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">'online'</span>, onOnline);
    <span class="hljs-comment">// ...</span>
  }, [onEvent]);
}
</div></code></pre>
<h3 id="114-scaling-recommendations">11.4 Scaling Recommendations</h3>
<h4 id="1141-redis-backed-event-store">11.4.1 Redis-Backed Event Store</h4>
<p>For production scalability:</p>
<pre class="hljs"><code><div><span class="hljs-comment">// Proposed: Replace in-memory ring with Redis Streams</span>

<span class="hljs-keyword">import</span> { Redis } <span class="hljs-keyword">from</span> <span class="hljs-string">"@upstash/redis"</span>;

<span class="hljs-keyword">const</span> redis = <span class="hljs-keyword">new</span> Redis({ <span class="hljs-comment">/* config */</span> });

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pushEvent</span>(<span class="hljs-params">event: FeedEvent</span>) </span>{
  <span class="hljs-keyword">await</span> redis.xadd(
    <span class="hljs-string">"agora:events"</span>,
    <span class="hljs-string">"*"</span>,  <span class="hljs-comment">// Auto-generate ID</span>
    { data: <span class="hljs-built_in">JSON</span>.stringify(event) }
  );
  
  <span class="hljs-comment">// Trim to keep last N events</span>
  <span class="hljs-keyword">await</span> redis.xtrim(<span class="hljs-string">"agora:events"</span>, { strategy: <span class="hljs-string">"MAXLEN"</span>, threshold: <span class="hljs-number">10000</span> });
}

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getEventsSince</span>(<span class="hljs-params">lastId: <span class="hljs-built_in">string</span></span>) </span>{
  <span class="hljs-keyword">return</span> redis.xrange(<span class="hljs-string">"agora:events"</span>, lastId, <span class="hljs-string">"+"</span>, <span class="hljs-number">100</span>);
}
</div></code></pre>
<h4 id="1142-horizontal-scaling-with-redis-pubsub">11.4.2 Horizontal Scaling with Redis Pub/Sub</h4>
<pre class="hljs"><code><div>┌─────────────────────────────────────────────────────────────────────────┐
│                    PROPOSED: Redis Pub/Sub Architecture                 │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│  Instance 1 │  │  Instance 2 │  │  Instance 3 │
│             │  │             │  │             │
│ EventSource │  │ EventSource │  │ EventSource │
│ connections │  │ connections │  │ connections │
└──────┬──────┘  └──────┬──────┘  └──────┬──────┘
       │                │                │
       └────────────────┼────────────────┘
                        │
                        ▼
           ┌────────────────────────┐
           │      Redis Pub/Sub     │
           │                        │
           │  Channel: agora:events │
           └────────────────────────┘
                        │
                        ▼
           ┌────────────────────────┐
           │    Redis Streams       │
           │                        │
           │  Stream: agora:events  │
           │  (persistent history)  │
           └────────────────────────┘
</div></code></pre>
<h4 id="1143-connection-pooling">11.4.3 Connection Pooling</h4>
<p>For high connection count:</p>
<pre class="hljs"><code><div><span class="hljs-comment">// Proposed: Use connection pooling service</span>
<span class="hljs-comment">// e.g., Pusher, Ably, or self-hosted solution</span>

<span class="hljs-comment">// Instead of direct EventSource:</span>
<span class="hljs-keyword">const</span> socket = <span class="hljs-keyword">new</span> PusherClient(<span class="hljs-string">'app_key'</span>, {
  cluster: <span class="hljs-string">'us2'</span>,
  forceTLS: <span class="hljs-literal">true</span>
});

<span class="hljs-keyword">const</span> channel = socket.subscribe(<span class="hljs-string">'agora-events'</span>);
channel.bind(<span class="hljs-string">'event'</span>, <span class="hljs-function">(<span class="hljs-params">data: AgoraEvent</span>) =&gt;</span> {
  handle(data);
});
</div></code></pre>
<h3 id="115-performance-metrics">11.5 Performance Metrics</h3>
<h4 id="1151-current-characteristics">11.5.1 Current Characteristics</h4>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Value</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Max concurrent connections</td>
<td>~50/process</td>
<td>EventEmitter limit</td>
</tr>
<tr>
<td>Event buffer size</td>
<td>2048</td>
<td>In-memory ring</td>
</tr>
<tr>
<td>Client feed cap</td>
<td>200-300</td>
<td>UI responsiveness</td>
</tr>
<tr>
<td>Heartbeat interval</td>
<td>20s</td>
<td>Keep-alive</td>
</tr>
<tr>
<td>Safety backfill</td>
<td>60s</td>
<td>Polling fallback</td>
</tr>
<tr>
<td>Bundle window (dialogue)</td>
<td>3 min</td>
<td>Coalescing</td>
</tr>
<tr>
<td>Bundle window (citations)</td>
<td>2 min</td>
<td>Coalescing</td>
</tr>
</tbody>
</table>
<h4 id="1152-recommendations-for-scale">11.5.2 Recommendations for Scale</h4>
<table>
<thead>
<tr>
<th>Scale</th>
<th>Recommendation</th>
</tr>
</thead>
<tbody>
<tr>
<td>&lt; 100 concurrent users</td>
<td>Current architecture sufficient</td>
</tr>
<tr>
<td>100-1000 users</td>
<td>Add Redis Streams for persistence</td>
</tr>
<tr>
<td>1000-10000 users</td>
<td>Redis Pub/Sub + connection pooling</td>
</tr>
<tr>
<td>&gt; 10000 users</td>
<td>Dedicated real-time service (Pusher/Ably)</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="12-appendices">12. Appendices</h2>
<h3 id="a1-file-reference">A.1 File Reference</h3>
<h4 id="a11-frontend-components">A.1.1 Frontend Components</h4>
<table>
<thead>
<tr>
<th>File</th>
<th>Location</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>Agora.tsx</td>
<td><code>app/agora/ui/Agora.tsx</code></td>
<td>Main feed component (832 lines)</td>
</tr>
<tr>
<td>EventCard.tsx</td>
<td><code>app/agora/ui/EventCard.tsx</code></td>
<td>Event card display (~175 lines)</td>
</tr>
<tr>
<td>TopBar.tsx</td>
<td><code>app/agora/ui/TopBar.tsx</code></td>
<td>Navigation header (~122 lines)</td>
</tr>
<tr>
<td>RightRail.tsx</td>
<td><code>app/agora/ui/RightRail.tsx</code></td>
<td>Context panel (~90 lines)</td>
</tr>
<tr>
<td>FiltersPanel.tsx</td>
<td><code>app/agora/ui/FiltersPanels.tsx</code></td>
<td>Filter sidebar (~15 lines)</td>
</tr>
<tr>
<td>StackSummaryCard.tsx</td>
<td><code>app/agora/ui/StackSummaryCard.tsx</code></td>
<td>Stack info (~30 lines)</td>
</tr>
<tr>
<td>page.tsx</td>
<td><code>app/agora/page.tsx</code></td>
<td>Server entry point</td>
</tr>
<tr>
<td>LiveEventsProvider.tsx</td>
<td><code>app/agora/LiveEventsProvider.tsx</code></td>
<td>SSE provider (~170 lines)</td>
</tr>
</tbody>
</table>
<h4 id="a12-plexus-components">A.1.2 Plexus Components</h4>
<table>
<thead>
<tr>
<th>File</th>
<th>Location</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>Plexus.tsx</td>
<td><code>components/agora/Plexus.tsx</code></td>
<td>Force-directed graph (1010 lines)</td>
</tr>
<tr>
<td>PlexusBoard.tsx</td>
<td><code>components/agora/PlexusBoard.tsx</code></td>
<td>Card grid view (960 lines)</td>
</tr>
<tr>
<td>PlexusMatrix.tsx</td>
<td><code>components/agora/PlexusMatrix.tsx</code></td>
<td>Adjacency matrix (331 lines)</td>
</tr>
<tr>
<td>PlexusRoomMetrics.tsx</td>
<td><code>components/agora/PlexusRoomMetrics.tsx</code></td>
<td>Room stats (~100 lines)</td>
</tr>
<tr>
<td>RoomAndDebatePickers.tsx</td>
<td><code>components/agora/RoomAndDebatePickers.tsx</code></td>
<td>Selector components (~75 lines)</td>
</tr>
<tr>
<td>ConfidenceControls.tsx</td>
<td><code>components/agora/ConfidenceControls.tsx</code></td>
<td>Mode selector (~50 lines)</td>
</tr>
<tr>
<td>useConfidence.tsx</td>
<td><code>components/agora/useConfidence.tsx</code></td>
<td>Confidence context</td>
</tr>
</tbody>
</table>
<h4 id="a13-debate-sheet-components">A.1.3 Debate Sheet Components</h4>
<table>
<thead>
<tr>
<th>File</th>
<th>Location</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>DebateSheetReader.tsx</td>
<td><code>components/agora/DebateSheetReader.tsx</code></td>
<td>Debate sheet view (533 lines)</td>
</tr>
<tr>
<td>DebateSheetHeader.tsx</td>
<td><code>components/deepdive/v3/debate-sheet/DebateSheetHeader.tsx</code></td>
<td>Sheet header</td>
</tr>
<tr>
<td>DebateSheetFilters.tsx</td>
<td><code>components/deepdive/v3/debate-sheet/DebateSheetFilters.tsx</code></td>
<td>Sheet filters</td>
</tr>
<tr>
<td>ArgumentNetworkCard.tsx</td>
<td><code>components/deepdive/v3/debate-sheet/ArgumentNetworkCard.tsx</code></td>
<td>Argument card</td>
</tr>
<tr>
<td>SupportBar.tsx</td>
<td><code>components/evidence/SupportBar.tsx</code></td>
<td>Confidence bar</td>
</tr>
</tbody>
</table>
<h4 id="a14-client-hooks">A.1.4 Client Hooks</h4>
<table>
<thead>
<tr>
<th>File</th>
<th>Location</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>useFollowing.ts</td>
<td><code>lib/client/useFollowing.ts</code></td>
<td>Room/tag following</td>
</tr>
<tr>
<td>useStackFollowing.ts</td>
<td><code>lib/client/useStackFollowing.ts</code></td>
<td>Stack subscriptions</td>
</tr>
<tr>
<td>useBusEffect.ts</td>
<td><code>lib/client/useBusEffect.ts</code></td>
<td>SSE subscription hook (~140 lines)</td>
</tr>
</tbody>
</table>
<h4 id="a15-server-infrastructure">A.1.5 Server Infrastructure</h4>
<table>
<thead>
<tr>
<th>File</th>
<th>Location</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>bus.ts</td>
<td><code>lib/server/bus.ts</code></td>
<td>Event bus singleton</td>
</tr>
<tr>
<td>topics.ts</td>
<td><code>lib/events/topics.ts</code></td>
<td>BusEvent definitions</td>
</tr>
<tr>
<td>route.ts</td>
<td><code>app/api/events/route.ts</code></td>
<td>SSE endpoint</td>
</tr>
<tr>
<td>route.ts</td>
<td><code>app/api/agora/events/route.ts</code></td>
<td>Historical events</td>
</tr>
<tr>
<td>route.ts</td>
<td><code>app/api/agora/network/route.ts</code></td>
<td>Network graph</td>
</tr>
<tr>
<td>route.ts</td>
<td><code>app/api/agora/rooms/route.ts</code></td>
<td>Room list</td>
</tr>
<tr>
<td>route.ts</td>
<td><code>app/api/follow/route.ts</code></td>
<td>Follow API</td>
</tr>
</tbody>
</table>
<h3 id="a2-event-type-reference">A.2 Event Type Reference</h3>
<table>
<thead>
<tr>
<th>Event</th>
<th>Payload</th>
<th>Source</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dialogue:moves:refresh</code></td>
<td><code>{ deliberationId, moveId, kind }</code></td>
<td>Move creation</td>
</tr>
<tr>
<td><code>dialogue:changed</code></td>
<td><code>{ deliberationId, moveId, kind, chips }</code></td>
<td>Dialogue state change</td>
</tr>
<tr>
<td><code>dialogue:cs:refresh</code></td>
<td><code>{ deliberationId, participantId }</code></td>
<td>Commitment store update</td>
</tr>
<tr>
<td><code>citations:changed</code></td>
<td><code>{ targetType, targetId, sourceId, url, quote, note }</code></td>
<td>Citation addition</td>
</tr>
<tr>
<td><code>decision:changed</code></td>
<td><code>{ deliberationId, kind, rationale }</code></td>
<td>Accept/reject decision</td>
</tr>
<tr>
<td><code>votes:changed</code></td>
<td><code>{ deliberationId, sessionId, method }</code></td>
<td>Vote update</td>
</tr>
<tr>
<td><code>stacks:changed</code></td>
<td><code>{ stackId, op }</code></td>
<td>Stack modification</td>
</tr>
<tr>
<td><code>comments:changed</code></td>
<td><code>{ stackId, discussionId, op }</code></td>
<td>Comment CRUD</td>
</tr>
<tr>
<td><code>deliberations:created</code></td>
<td><code>{ id, hostType, hostId }</code></td>
<td>New deliberation</td>
</tr>
<tr>
<td><code>xref:changed</code></td>
<td><code>{ fromType, fromId, toType, toId, relation }</code></td>
<td>Cross-reference</td>
</tr>
<tr>
<td><code>claims:edges:changed</code></td>
<td><code>{ deliberationId, claimId }</code></td>
<td>Claim relationship</td>
</tr>
<tr>
<td><code>cqs:changed</code></td>
<td><code>{ deliberationId, argumentId }</code></td>
<td>Critical question update</td>
</tr>
<tr>
<td><code>cards:changed</code></td>
<td><code>{ deliberationId }</code></td>
<td>Card update</td>
</tr>
<tr>
<td><code>issues:changed</code></td>
<td><code>{ deliberationId, issueId }</code></td>
<td>Issue update</td>
</tr>
</tbody>
</table>
<h3 id="a3-icon-reference">A.3 Icon Reference</h3>
<table>
<thead>
<tr>
<th>Icon Key</th>
<th>Symbol</th>
<th>Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>move</code></td>
<td><code>»</code></td>
<td>Dialogue moves</td>
</tr>
<tr>
<td><code>link</code></td>
<td><code>⛓</code></td>
<td>Citations, sources</td>
</tr>
<tr>
<td><code>check</code></td>
<td><code>✓</code></td>
<td>Decisions</td>
</tr>
<tr>
<td><code>vote</code></td>
<td><code>☑</code></td>
<td>Votes</td>
</tr>
<tr>
<td><code>branch</code></td>
<td><code>⑂</code></td>
<td>Cross-references</td>
</tr>
<tr>
<td><code>plus</code></td>
<td><code>⊕</code></td>
<td>New deliberations</td>
</tr>
<tr>
<td><code>stack</code></td>
<td><code>⧉</code></td>
<td>Stack updates</td>
</tr>
<tr>
<td><code>chat</code></td>
<td><code>✉</code></td>
<td>Comments</td>
</tr>
</tbody>
</table>
<h3 id="a4-url-patterns">A.4 URL Patterns</h3>
<table>
<thead>
<tr>
<th>Pattern</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/agora</code></td>
<td>Main Agora feed</td>
</tr>
<tr>
<td><code>/deliberation/[id]</code></td>
<td>Deliberation view</td>
</tr>
<tr>
<td><code>/deliberation/[id]?mode=forum</code></td>
<td>Forum mode</td>
</tr>
<tr>
<td><code>/deliberation/[id]?mode=panel</code></td>
<td>Panel mode</td>
</tr>
<tr>
<td><code>/deliberation/[id]?mode=synthesis</code></td>
<td>Synthesis mode</td>
</tr>
<tr>
<td><code>/deliberation/[id]/dialoguetimeline</code></td>
<td>Timeline view</td>
</tr>
<tr>
<td><code>/stacks/[id]</code></td>
<td>Stack view</td>
</tr>
<tr>
<td><code>/stacks/[id]#c=[commentId]</code></td>
<td>Comment anchor</td>
</tr>
<tr>
<td><code>/claim/[id]</code></td>
<td>Claim detail</td>
</tr>
<tr>
<td><code>/hub</code></td>
<td>Deliberations hub</td>
</tr>
</tbody>
</table>
<h3 id="a5-localstorage-keys">A.5 LocalStorage Keys</h3>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>agora:activeRoom</code></td>
<td>string</td>
<td>Currently selected room</td>
</tr>
<tr>
<td><code>agora:activeSheet</code></td>
<td>string</td>
<td>Currently selected sheet</td>
</tr>
<tr>
<td><code>agora:lastEventId</code></td>
<td>string</td>
<td>SSE resume point (sessionStorage)</td>
</tr>
<tr>
<td><code>plexus:edgeOn</code></td>
<td><code>Record&lt;EdgeKind, boolean&gt;</code></td>
<td>Edge type toggles</td>
</tr>
<tr>
<td><code>plexus:bundle</code></td>
<td>boolean</td>
<td>Edge bundling toggle</td>
</tr>
<tr>
<td><code>plexus:order</code></td>
<td>OrderBy</td>
<td>Room sort order</td>
</tr>
<tr>
<td><code>plexus:labels</code></td>
<td>LabelMode</td>
<td>Label display mode</td>
</tr>
<tr>
<td><code>plexus:q</code></td>
<td>string</td>
<td>Search query</td>
</tr>
</tbody>
</table>
<h3 id="a6-css-classes-reference">A.6 CSS Classes Reference</h3>
<table>
<thead>
<tr>
<th>Class</th>
<th>Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>menuv2--lite</code></td>
<td>Lightweight dropdown styling</td>
</tr>
<tr>
<td><code>btnv2--ghost</code></td>
<td>Ghost button styling</td>
</tr>
<tr>
<td><code>lockbutton</code></td>
<td>Locked/primary button</td>
</tr>
<tr>
<td><code>savebutton</code></td>
<td>Save action button</td>
</tr>
<tr>
<td><code>minorfield</code></td>
<td>Compact input field</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="document-history">Document History</h2>
<table>
<thead>
<tr>
<th>Version</th>
<th>Date</th>
<th>Author</th>
<th>Changes</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.0</td>
<td>January 2025</td>
<td>System</td>
<td>Initial comprehensive documentation</td>
</tr>
</tbody>
</table>
<hr>
<p><em>End of Document</em></p>

</body>
</html>
